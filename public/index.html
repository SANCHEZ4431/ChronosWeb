<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos Master Control v4.0 Holographic</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020205;
            --surface: rgba(15, 15, 30, 0.7);
            --surface-bright: rgba(26, 26, 46, 0.9);
            --accent: #00f2ff;
            --accent-glow: rgba(0, 242, 255, 0.4);
            --text: #e2e8f0;
            --text-dim: #94a3b8;
            --danger: #ff0055;
            --success: #00ffaa;
            --vip: #ffcc00;
            --border: rgba(255, 255, 255, 0.1);
            --font-main: 'Plus Jakarta Sans', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; transition: all 0.2s ease-out; }

        body {
            font-family: var(--font-main);
            background: var(--bg);
            background-image: 
                radial-gradient(circle at 50% -20%, #1a1a3e 0%, transparent 50%),
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            color: var(--text);
            margin: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; box-shadow: 0 0 10px var(--accent-glow); }

        .container { max-width: 1600px; margin: 0 auto; padding: 40px 20px; }

        /* --- Header & Glass Panels --- */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 25px;
            background: var(--surface);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 24px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .logo h1 {
            margin: 0; font-size: 24px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px;
            background: linear-gradient(90deg, #fff, var(--accent));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 8px var(--accent-glow));
        }

        .stats-overview { display: flex; gap: 15px; align-items: center; }

        .stat-pill {
            background: rgba(255,255,255,0.03);
            padding: 10px 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 13px; font-weight: 600;
        }
        .stat-pill span { color: var(--accent); text-shadow: 0 0 10px var(--accent-glow); }

        /* --- Search Bar --- */
        .search-container {
            position: relative; margin-bottom: 30px;
        }
        .search-container input {
            width: 100%; height: 60px; background: var(--surface);
            border: 1px solid var(--border); border-radius: 18px;
            padding: 0 60px; color: #fff; font-size: 16px;
            backdrop-filter: blur(10px);
        }
        .search-container input:focus {
            border-color: var(--accent); outline: none; box-shadow: 0 0 20px var(--accent-glow);
        }
        .search-icon { position: absolute; left: 25px; top: 18px; color: var(--accent); font-size: 20px; }

        /* --- Table Styling --- */
        .table-card {
            background: var(--surface); backdrop-filter: blur(12px);
            border-radius: 24px; border: 1px solid var(--border); overflow: hidden;
        }
        table { width: 100%; border-collapse: collapse; }
        th { 
            text-align: left; padding: 20px; font-size: 11px; text-transform: uppercase; 
            letter-spacing: 2px; color: var(--text-dim); border-bottom: 1px solid var(--border);
        }
        td { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.02); font-size: 14px; }
        tr:hover td { background: rgba(0, 242, 255, 0.05); cursor: pointer; }

        .avatar-stub {
            width: 40px; height: 40px; border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), #0066ff);
            color: #000; font-weight: 800; display: flex; align-items: center; justify-content: center;
        }

        /* --- Badges --- */
        .badge {
            padding: 5px 12px; border-radius: 8px; font-size: 10px; font-weight: 800; text-transform: uppercase;
        }
        .badge-vip { background: var(--vip); color: #000; box-shadow: 0 0 15px rgba(255,204,0,0.4); }
        .badge-admin { background: var(--danger); color: #fff; box-shadow: 0 0 15px rgba(255,0,85,0.4); }

        /* --- Modal System --- */
        #editForm {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90vw; max-width: 1300px; height: 85vh;
            background: var(--surface-bright); backdrop-filter: blur(30px);
            border-radius: 32px; border: 1px solid rgba(255,255,255,0.15);
            z-index: 1001; flex-direction: column; overflow: hidden;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }

        .tabs-header { 
            display: flex; gap: 10px; padding: 20px 30px; background: rgba(0,0,0,0.3);
        }
        .tab-btn {
            background: transparent; border: none; color: var(--text-dim); padding: 12px 24px;
            border-radius: 12px; cursor: pointer; font-weight: 600; font-size: 14px;
        }
        .tab-btn.active { background: var(--accent); color: #000; box-shadow: 0 0 20px var(--accent-glow); }

        .modal-scrollbox { padding: 40px; overflow-y: auto; flex-grow: 1; }
        
        .card-box {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border);
            border-radius: 20px; padding: 25px; margin-bottom: 20px;
        }
        .card-box h3 { 
            margin-top: 0; font-size: 12px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent);
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
        }

        /* --- Inputs --- */
        label { display: block; font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin: 15px 0 8px; font-weight: 700; }
        input, select, textarea {
            width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid var(--border);
            border-radius: 12px; color: #fff; font-family: var(--font-mono); font-size: 13px;
        }
        input:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.5); }

        /* --- Grid Layouts --- */
        .editor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 25px; }
        .dynamic-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }

        /* --- Inventory Tiles --- */
        .item-tile {
            background: rgba(0,0,0,0.4); padding: 20px; border-radius: 16px; border-top: 2px solid #444;
            position: relative; overflow: hidden;
        }
        .item-tile.legendary { border-top-color: var(--vip); background: linear-gradient(to bottom, rgba(255,204,0,0.1), transparent); }
        .item-tile.epic { border-top-color: #d000ff; }
        .item-tile.rare { border-top-color: #0077ff; }

        .btn {
            padding: 12px 25px; border-radius: 14px; border: none; font-weight: 700; cursor: pointer;
            display: flex; align-items: center; gap: 8px; justify-content: center;
        }
        .btn-save { background: var(--accent); color: #000; }
        .btn-save:hover { transform: translateY(-2px); box-shadow: 0 8px 20px var(--accent-glow); }
        .btn-close { background: rgba(255,255,255,0.05); color: #fff; border: 1px solid var(--border); }

        #overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,20,0.8);
            backdrop-filter: blur(8px); z-index: 1000;
        }

        #toast {
            position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: #000;
            padding: 16px 30px; border-radius: 16px; font-weight: 800; z-index: 9999;
            transform: translateY(200px); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #toast.visible { transform: translateY(0); }

        /* --- AI Memory Box --- */
        #ai-logs {
            background: rgba(0,0,0,0.5); border-radius: 16px; border: 1px solid var(--border);
            padding: 20px; font-family: var(--font-mono); line-height: 1.6;
        }

        /* --- Mobile --- */
        @media (max-width: 768px) {
            .editor-grid { grid-template-columns: 1fr; }
            header { flex-direction: column; gap: 20px; }
            .modal-scrollbox { padding: 20px; }
            #editForm { width: 100%; height: 100%; border-radius: 0; }
            td::before { content: attr(data-label); color: var(--accent); font-size: 10px; }
            tr { display: block; background: var(--surface); margin-bottom: 15px; border-radius: 15px; }
            td { display: flex; justify-content: space-between; border: none; }
            thead { display: none; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">
            <h1>Chronos <span style="font-weight: 400; opacity: 0.6;">Database</span></h1>
        </div>
        <div class="stats-overview">
            <div class="stat-pill">Database: <span id="count-users">0</span></div>
            <div class="stat-pill">Elite: <span id="count-vips">0</span></div>
            <button class="btn btn-save" onclick="loadUsers()" style="padding: 8px 15px; font-size: 11px;">SYNC</button>
            <button class="btn btn-close" onclick="logout()" style="padding: 8px 15px; font-size: 11px; color: var(--danger);">EXIT</button>
        </div>
    </header>

    <div class="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="userSearch" placeholder="SEARCH OPERATIVE BY ID OR ALIAS..." oninput="filterUsers()">
        <div class="stat-pill" style="position: absolute; right: 15px; top: 12px;">Found: <span id="count-found">0</span></div>
    </div>

    <div class="table-card">
        <table id="userTable">
            <thead>
                <tr>
                    <th>Identifier</th>
                    <th>Operative</th>
                    <th>Rank / Power</th>
                    <th>Credits</th>
                    <th>Inventory</th>
                    <th>Neural AI</th>
                    <th>Network Status</th>
                </tr>
            </thead>
            <tbody id="userList">
                <tr><td colspan="7" style="text-align:center; padding: 100px; color: var(--accent);">INITIALIZING NEXUS CONNECTION...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="overlay" onclick="closeEdit()"></div>

<div id="editForm">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab(event, 'p-main')">CORE PROFILE</button>
        <button class="tab-btn" onclick="openTab(event, 'p-res')">CARGO</button>
        <button class="tab-btn" onclick="openTab(event, 'p-skills')">AUGMENTS</button>
        <button class="tab-btn" onclick="openTab(event, 'p-inv')">ARMORY</button>
        <button class="tab-btn" onclick="openTab(event, 'p-nova')">NEURAL LINK</button>
        <button class="tab-btn" onclick="openTab(event, 'p-system')">SYSTEM</button>
    </div>

    <div class="modal-scrollbox">
        <div id="p-main" class="tab-content active">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üë§ Biological ID</h3>
                    <label>Internal GUID</label><input type="text" id="v-id" disabled>
                    <label>Operative Alias</label><input type="text" id="v-user">
                    <label>Power Level</label><input type="number" id="v-lvl">
                    <label>Neural XP</label><input type="number" id="v-xp">
                </div>
                <div class="card-box">
                    <h3>üíé Assets</h3>
                    <label>Gold Credits</label><input type="number" id="v-coins">
                    <label>Void Essence</label><input type="number" id="v-essence">
                    <label>Faction</label><input type="text" id="v-clan">
                </div>
                <div class="card-box">
                    <h3>üõ°Ô∏è Access Level</h3>
                    <label>Privilege Type</label>
                    <select id="v-is-admin" onchange="toggleAdmin(this.value)">
                        <option value="false">Standard Agent</option>
                        <option value="true">Root Administrator</option>
                    </select>
                    <label>Elite Status (VIP)</label>
                    <div id="vip-info" style="margin-bottom:15px; padding:12px; background:rgba(0,0,0,0.3); border-radius:12px; border-left:3px solid var(--vip);"></div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input type="number" id="vip-days-input" value="30" placeholder="Days">
                        <button class="btn btn-save" onclick="grantVipCustom()">GRANT</button>
                    </div>
                    <button class="btn btn-close" style="width:100%; color: var(--danger);" onclick="revokeVip()">REVOKE ACCESS</button>
                </div>
            </div>
        </div>

        <div id="p-res" class="tab-content">
            <div class="card-box">
                <h3>üì¶ Harvested Resources</h3>
                <div id="dynamic-res-grid" class="dynamic-grid"></div>
            </div>
        </div>

        <div id="p-skills" class="tab-content">
            <div class="card-box">
                <h3>‚ö° Active Augmentations</h3>
                <div id="dynamic-skills-grid" class="dynamic-grid"></div>
            </div>
        </div>

        <div id="p-inv" class="tab-content">
            <div class="card-box" style="background: rgba(0, 242, 255, 0.05); border-color: var(--accent);">
                <h3>‚ú® Matter Injection</h3>
                <div style="display:flex; gap:15px;">
                    <select id="add-item-sel" style="flex:2;"></select>
                    <input type="number" id="add-item-qty" value="1" style="flex:0.5;">
                    <button class="btn btn-save" onclick="addItemToInv()">INJECT</button>
                </div>
            </div>
            <div id="inv-list" class="dynamic-grid" style="margin-top:20px;"></div>
        </div>

        <div id="p-nova" class="tab-content">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üß† Neural Personality</h3>
                    <label>AI Designation</label><input type="text" id="ai-name">
                    <label>Sync Level</label><input type="number" id="ai-rel">
                    <label>Gender Core</label><input type="text" id="ai-gender">
                    <label>Linguistic Style</label><textarea id="ai-style" rows="4"></textarea>
                </div>
                <div class="card-box" style="grid-column: span 2;">
                    <h3>üéûÔ∏è Memory Buffer</h3>
                    <div id="ai-logs" style="height:400px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>

        <div id="p-system" class="tab-content">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üö´ Protocol Restrictions</h3>
                    <label>Blacklist Status</label>
                    <select id="v-banned">
                        <option value="false">Clear</option>
                        <option value="true">TERMINATED</option>
                    </select>
                    <label>Violation Count</label><input type="number" id="v-warns">
                </div>
                <div class="card-box">
                    <h3>üïí Temporal Cooldowns</h3>
                    <div id="cd-list" style="font-family: var(--font-mono); font-size: 12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer" style="padding: 25px 40px; background: rgba(0,0,0,0.3); display: flex; justify-content: flex-end; gap: 15px;">
        <button class="btn btn-close" onclick="closeEdit()">ABORT</button>
        <button class="btn btn-save" onclick="processSave()">COMMIT CHANGES</button>
    </div>
</div>

<div id="toast">SYSTEM SYNCED</div>

<script>
    /* –í–ï–°–¨ –í–ê–® JS-–ö–û–î –û–°–¢–ê–ï–¢–°–Ø –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô, –¢–ê–ö –ö–ê–ö ID –ò –ö–õ–ê–°–°–´ –°–û–•–†–ê–ù–ï–ù–´ */
    const RES_TYPES = ["gold", "wood", "stone", "iron", "magic_crystals", "ores", "fabric", "food", "rare_artifacts"];
    const SKILL_TYPES = ["exp_boost", "resource_gain", "luck", "gold_gain", "wisdom", "cooldown_reduction", "pet_bonus"];

    let allUsers = [];
    let activeUser = null;

    async function loadUsers() {
        try {
            const r = await fetch('/api/users');
            allUsers = await r.json();
            document.getElementById('userSearch').value = '';
            renderTable();
            updateStats();
        } catch(e) { console.error("API Error", e); }
    }

    function filterUsers() {
        const query = document.getElementById('userSearch').value.toLowerCase().trim();
        if (!query) { renderTable(allUsers); return; }
        const filtered = allUsers.filter(u => {
            const idMatch = String(u._id).includes(query);
            const nameMatch = (u.username || "").toLowerCase().includes(query.replace('@', ''));
            return idMatch || nameMatch;
        });
        renderTable(filtered);
    }
    
    function renderTable(dataToRender = allUsers) {
        const body = document.getElementById('userList');
        if (dataToRender.length === 0) {
            body.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 100px; color: var(--text-dim);">NO OPERATIVES FOUND IN THIS SECTOR.</td></tr>`;
            return;
        }
        body.innerHTML = dataToRender.map((u) => {
            const originalIndex = allUsers.findIndex(original => original._id === u._id);
            const isAdmin = u.is_admin === true;
            const isVip = u.is_vip === true; 
            const isBanned = u.banned === true;
            return `
            <tr onclick="editUser(${originalIndex})">
                <td data-label="ID">#${u._id}</td>
                <td data-label="User">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="avatar-stub">${(u.username || 'U').charAt(0).toUpperCase()}</div>
                        <b>@${u.username || 'Unknown'}</b>
                    </div>
                </td>
                <td data-label="Level">LVL ${u.level || 1} <br><small style="opacity:0.5">XP: ${u.exp || 0}</small></td>
                <td data-label="Money" style="color:var(--success)">${u.coins?.toLocaleString() || 0} CR</td>
                <td data-label="Resources">üì¶ ${Object.values(u.resources || {}).reduce((a,b)=>a+b, 0)}</td>
                <td data-label="AI">${u.ai_profile?.name || 'Nova'}</td>
                <td data-label="Status">
                    ${isBanned ? '<span class="badge" style="background:var(--danger)">Terminated</span>' : ''}
                    ${isAdmin ? '<span class="badge badge-admin">Root</span>' : ''}
                    ${isVip ? '<span class="badge badge-vip">Elite</span>' : ''}
                    ${!isAdmin && !isVip && !isBanned ? '<span class="badge" style="background:rgba(255,255,255,0.1)">Active</span>' : ''}
                </td>
            </tr>`;
        }).join('');
        document.getElementById('count-found').innerText = dataToRender.length;
    }

    function editUser(index) {
        activeUser = JSON.parse(JSON.stringify(allUsers[index]));
        document.getElementById('v-id').value = activeUser._id;
        document.getElementById('v-user').value = activeUser.username || '';
        document.getElementById('v-lvl').value = activeUser.level || 1;
        document.getElementById('v-xp').value = activeUser.exp || activeUser.xp || 0;
        document.getElementById('v-coins').value = activeUser.coins || 0;
        document.getElementById('v-essence').value = activeUser.essence || 0;
        document.getElementById('v-is-admin').value = String(activeUser.is_admin || false);
        document.getElementById('v-clan').value = activeUser.clan_id || '';
        document.getElementById('v-banned').value = String(activeUser.banned || false);
        document.getElementById('v-warns').value = activeUser.warns || 0;

        updateVipUI();

        const resGrid = document.getElementById('dynamic-res-grid');
        resGrid.innerHTML = RES_TYPES.map(rt => `
            <div>
                <label>${rt.replace(/_/g,' ')}</label>
                <input type="number" value="${activeUser.resources?.[rt] || 0}" data-res-key="${rt}">
            </div>
        `).join('');

        const skillGrid = document.getElementById('dynamic-skills-grid');
        skillGrid.innerHTML = SKILL_TYPES.map(st => `
            <div>
                <label>${st.replace(/_/g,' ')}</label>
                <input type="number" value="${activeUser.skills?.[st] || 0}" data-skill-key="${st}">
            </div>
        `).join('');

        const ai = activeUser.ai_profile || {};
        document.getElementById('ai-name').value = ai.name || 'Nova';
        document.getElementById('ai-rel').value = ai.relationship_level || 0;
        document.getElementById('ai-gender').value = ai.gender || '';
        document.getElementById('ai-style').value = ai.speech_style || '';

        const aiLogs = document.getElementById('ai-logs');
        if (activeUser.ai_history && activeUser.ai_history.length > 0) {
            aiLogs.innerHTML = activeUser.ai_history.map(msg => `
                <div style="margin-bottom: 12px; padding: 10px; background:rgba(255,255,255,0.02); border-radius:8px;">
                    <span style="color: var(--accent); font-size:10px;">[${msg.role?.toUpperCase()}]</span><br> 
                    <span style="color: #ccc; font-size:13px;">${msg.content}</span>
                </div>
            `).join('');
        } else { aiLogs.innerHTML = 'MEMORY EMPTY'; }

        const cdList = document.getElementById('cd-list');
        const cds = activeUser.cooldowns || {};
        if (Object.keys(cds).length > 0) {
            cdList.innerHTML = Object.entries(cds).map(([k, v]) => {
                const dateValue = (v && typeof v === 'object' && v.$date) ? v.$date : v;
                if (!dateValue) return `<div><b>${k}:</b> READY</div>`;
                const date = new Date(dateValue);
                return `<div style="color:var(--danger); margin-bottom: 5px;"><b>${k}:</b> ‚è≥ ${date.toLocaleString()}</div>`;
            }).join('');
        } else { cdList.innerHTML = 'NO ACTIVE COOLDOWNS'; }

        renderInv();
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editForm').style.display = 'flex';
    }
        
    function updateVipUI() {
        const vipInfo = document.getElementById('vip-info');
        if (activeUser.is_vip) {
            const expiryDate = activeUser.vip_until ? new Date(activeUser.vip_until).toLocaleDateString() : "LIFETIME";
            vipInfo.innerHTML = `<b style="color:var(--vip)">ACTIVE PROTOCOL</b><br>EXPIRES: ${expiryDate}`;
        } else {
            vipInfo.innerHTML = `<b style="color:var(--text-dim)">INACTIVE PROTOCOL</b>`;
        }
    }

    async function grantVipCustom() {
        const days = document.getElementById('vip-days-input').value;
        if (!days || days <= 0) return alert("ENTER VALID CYCLE COUNT");
        try {
            const res = await fetch('/api/set-vip', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: activeUser._id, days: parseInt(days) })
            });
            if(res.ok) {
                showToast(`VIP GRANTED: ${days} DAYS`);
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + parseInt(days));
                activeUser.is_vip = true;
                activeUser.vip_until = newDate;
                updateVipUI();
            }
        } catch(e) { alert("COMMS ERROR"); }
    }

    async function revokeVip() {
        if(!confirm("TERMINATE ELITE STATUS?")) return;
        activeUser.is_vip = false;
        activeUser.vip_until = null;
        processSave();
    }

    async function toggleAdmin(val) {
        const action = val === 'true' ? 'add' : 'remove';
        try {
            const res = await fetch('/api/set-admin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: activeUser._id, action: action })
            });
            if(res.ok) showToast(`PRIVILEGE: ${val}`);
        } catch(e) { console.error(e); }
    }

    function renderInv() {
        const box = document.getElementById('inv-list');
        box.innerHTML = '';
        const items = activeUser.inventory || {};
        for (let key in items) {
            let amount, rarity;
            if (typeof items[key] === 'object' && items[key] !== null) {
                amount = items[key].amount || 0;
                rarity = items[key].rarity || 'common';
            } else {
                amount = items[key]; rarity = 'common'; 
            }
            if (['exp', 'coins', 'resources'].includes(key)) continue;
            box.innerHTML += `
                <div class="item-tile ${rarity}">
                    <span style="display:block; font-weight:800; font-size:12px;">${key}</span>
                    <span style="color:var(--accent); font-family:var(--font-mono)">x${amount}</span>
                    <button onclick="remItem('${key}')" style="position:absolute; top:5px; right:5px; background:none; border:none; color:var(--danger); cursor:pointer;">√ó</button>
                </div>
            `;
        }
    }

    const AVAILABLE_ITEMS = [
        {"name": "Talisman of Knowledge", "rarity": "common"},
        {"name": "Coin Bank", "rarity": "common"},
        {"name": "Traveler‚Äôs Compass", "rarity": "common"},
        {"name": "Wooden Ring", "rarity": "common"},
        {"name": "Lucky Charm", "rarity": "common"},
        {"name": "Energy Drink", "rarity": "rare"},
        {"name": "Amulet of Wisdom", "rarity": "rare"},
        {"name": "Silver Quill", "rarity": "rare"},
        {"name": "Ring of Focus", "rarity": "rare"},
        {"name": "Scholar‚Äôs Book", "rarity": "rare"},
        {"name": "Golden Purse", "rarity": "epic"},
        {"name": "Crystal of Luck", "rarity": "epic"},
        {"name": "Cloak of Insight", "rarity": "epic"},
        {"name": "Orb of Fortune", "rarity": "epic"},
        {"name": "Crown of Clarity", "rarity": "epic"},
        {"name": "Crown of Mastery", "rarity": "legendary"},
        {"name": "Philosopher's Stone", "rarity": "legendary"},
        {"name": "Eternal Flame", "rarity": "legendary"},
        {"name": "Timekeeper‚Äôs Hourglass", "rarity": "legendary"},
        {"name": "Book of Eternity", "rarity": "legendary"},
        {"name": "shadow_note", "rarity": "common"}
    ];
    
    function initItemSelector() {
        const sel = document.getElementById('add-item-sel');
        sel.innerHTML = AVAILABLE_ITEMS.map(item => {
            return `<option value="${item.name}">${item.name} [${item.rarity.toUpperCase()}]</option>`;
        }).join('');
    }
    
    function addItemToInv() {
        const name = document.getElementById('add-item-sel').value;
        const qty = parseInt(document.getElementById('add-item-qty').value);
        const itemData = AVAILABLE_ITEMS.find(i => i.name === name);
        const rarity = itemData && itemData.rarity ? itemData.rarity : 'common';
        if(!activeUser.inventory) activeUser.inventory = {};
        if (typeof activeUser.inventory[name] === 'number') {
            activeUser.inventory[name] = { amount: activeUser.inventory[name] + qty, rarity: rarity };
        } else if (activeUser.inventory[name]) {
            activeUser.inventory[name].amount += qty;
        } else {
            activeUser.inventory[name] = { amount: qty, rarity: rarity };
        }
        renderInv();
        showToast(`MATTER INJECTED: ${name}`);
    }
    
    function remItem(key) {
        delete activeUser.inventory[key];
        renderInv();
    }

    async function processSave() {
        const update = {
            username: document.getElementById('v-user').value,
            level: Number(document.getElementById('v-lvl').value),
            exp: Number(document.getElementById('v-xp').value),
            coins: Number(document.getElementById('v-coins').value),
            essence: Number(document.getElementById('v-essence').value),
            clan_id: document.getElementById('v-clan').value,
            is_admin: document.getElementById('v-is-admin').value === 'true',
            banned: document.getElementById('v-banned').value === 'true',
            warns: Number(document.getElementById('v-warns').value),
            is_vip: activeUser.is_vip,
            vip_until: activeUser.vip_until,
            inventory: activeUser.inventory,
            "ai_profile.name": document.getElementById('ai-name').value,
            "ai_profile.relationship_level": Number(document.getElementById('ai-rel').value),
            "ai_profile.gender": document.getElementById('ai-gender').value,
            "ai_profile.speech_style": document.getElementById('ai-style').value
        };
        document.querySelectorAll('[data-res-key]').forEach(el => {
            update[`resources.${el.dataset.resKey}`] = Number(el.value);
        });
        document.querySelectorAll('[data-skill-key]').forEach(el => {
            update[`skills.${el.dataset.skillKey}`] = Number(el.value);
        });
        const res = await fetch('/api/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: activeUser._id, updateData: update })
        });
        if(res.ok) { showToast("DATABASE SYNCED"); closeEdit(); loadUsers(); }
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function closeEdit() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editForm').style.display = 'none';
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m; t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 3000);
    }

    function updateStats() {
        document.getElementById('count-users').innerText = allUsers.length;
        document.getElementById('count-vips').innerText = allUsers.filter(u => u.is_vip || (u.vip_until && new Date(u.vip_until) > new Date())).length;
    }

    async function logout() {
        if (!confirm("TERMINATE SESSION?")) return;
        try {
            const res = await fetch('/api/logout', { method: 'POST' });
            if (res.ok) window.location.href = '/login.html';
        } catch (e) { window.location.reload(); }
    }

    window.addEventListener('load', () => {
        initItemSelector();
        loadUsers();
    });
</script>
</body>
</html>
