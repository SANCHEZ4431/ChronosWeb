<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chronos Master Control v2.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0b14; --surface: #161625; --accent: #5da9ff; --text: #e0e0e0;
            --legendary: #ffae00; --epic: #bf40bf; --rare: #0070dd; --common: #ffffff;
            --danger: #ff4d4d; --success: #2ecc71; --vip: #f1c40f;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; }
        table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 12px; overflow: hidden; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2d2d44; }
        th { background: #1f1f35; color: var(--accent); font-size: 11px; text-transform: uppercase; }
        tr:hover { background: #1f1f35; cursor: pointer; }

        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; }
        #editForm {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--surface); width: 1100px; max-height: 95vh; border-radius: 20px;
            z-index: 1000; overflow: hidden; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        .tabs { display: flex; background: #1f1f35; padding: 10px 20px 0; gap: 5px; }
        .tab-btn { padding: 12px 20px; border: none; background: none; color: #888; cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--surface); color: var(--accent); }

        .content { padding: 25px; overflow-y: auto; flex-grow: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .section { background: #1f1f35; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .section h4 { margin: 0 0 10px 0; color: var(--accent); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid #2d2d44; padding-bottom: 5px; }

        label { display: block; font-size: 10px; color: #888; margin-top: 8px; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; margin-top: 4px; background: #0b0b14; border: 1px solid #2d2d44; color: #fff; border-radius: 5px; box-sizing: border-box; }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π */
        .tag-editable { display: inline-flex; align-items: center; background: #2d2d44; padding: 4px 10px; border-radius: 4px; font-size: 11px; margin: 4px; border: 1px solid #3d3d5c; }
        .tag-editable .remove { margin-left: 8px; color: var(--danger); cursor: pointer; font-weight: bold; }
        
        .cd-item { display: flex; justify-content: space-between; align-items: center; background: #0b0b14; padding: 8px; border-radius: 6px; margin-bottom: 5px; border: 1px solid #2d2d44; }
        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; text-transform: uppercase; }

        .footer { padding: 15px 25px; background: #1f1f35; display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: var(--accent); color: #000; }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-vip { background: var(--vip); color: #000; }
        .btn-close { background: #3d3d5c; color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--accent);">Chronos Master Control <small style="font-size: 12px; color: #666;">v2.5 Full Access</small></h1>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Level</th>
                <th>Coins</th>
                <th>Status</th>
                <th>Messages</th>
            </tr>
        </thead>
        <tbody id="userList"></tbody>
    </table>
</div>

<div id="overlay" onclick="closeEdit()"></div>

<div id="editForm">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'main')">üìä PROFILE</button>
        <button class="tab-btn" onclick="openTab(event, 'privileges')">üõ°Ô∏è PRIVILEGES</button>
        <button class="tab-btn" onclick="openTab(event, 'nova')">ü§ñ NOVA AI</button>
        <button class="tab-btn" onclick="openTab(event, 'system')">‚öôÔ∏è SYSTEM</button>
    </div>

    <div class="content">
        <div id="main" class="tab-content active">
            <div class="grid">
                <div class="section">
                    <h4>Basic Data</h4>
                    <label>Telegram ID</label><input type="text" id="v-id" disabled>
                    <label>Username</label><input type="text" id="v-user">
                    <label>Coins</label><input type="number" id="v-coins">
                    <label>Level</label><input type="number" id="v-lvl">
                </div>
                <div class="section">
                    <h4>Edit Achievements</h4>
                    <div id="achievementsContainer" style="min-height: 100px; border: 1px solid #2d2d44; padding: 10px; border-radius: 8px; margin-bottom: 10px;"></div>
                    <div style="display:flex; gap:5px;">
                        <input type="text" id="new-ach-input" placeholder="Achievement name..." style="font-size: 12px;">
                        <button class="btn btn-save" onclick="addAchievement()" style="padding: 5px 12px;">+</button>
                    </div>
                </div>
                <div class="section">
                    <h4>Resource Warehouse</h4>
                    <div id="resGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;"></div>
                </div>
            </div>
        </div>

        <div id="privileges" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h4>VIP Management</h4>
                    <div id="vipInfoBox" style="padding: 10px; background: #0b0b14; border-radius: 8px; margin-bottom: 15px;">
                        –°—Ç–∞—Ç—É—Å: <span id="vipStatusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <label>Add VIP Days</label>
                    <input type="number" id="vip-days" value="30">
                    <button class="btn btn-vip" onclick="handleSetVip()" style="width: 100%; margin-top: 10px;">Set/Update VIP</button>
                </div>
                <div class="section">
                    <h4>Admin Access</h4>
                    <div id="adminInfoBox" style="padding: 10px; background: #0b0b14; border-radius: 8px; margin-bottom: 15px;">
                        –ü—Ä–∞–≤–∞: <span id="adminStatusText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <button id="adminToggleBtn" class="btn btn-danger" onclick="handleToggleAdmin()" style="width: 100%;">Toggle Admin Status</button>
                </div>
            </div>
        </div>

        <div id="nova" class="tab-content">
            <div class="section">
                <h4>AI Configuration</h4>
                <div class="grid">
                    <div><label>Name</label><input type="text" id="ai-name"></div>
                    <div><label>Rel. Level</label><input type="number" id="ai-rel"></div>
                    <div><label>Mood</label><input type="text" id="ai-mood"></div>
                </div>
            </div>
        </div>

        <div id="system" class="tab-content">
            <div class="section">
                <h4>Active Cooldowns</h4>
                <div id="cooldownsList"></div>
                <p style="font-size: 10px; color: #666; margin-top: 10px;">* –ù–∞–∂–º–∏—Ç–µ "Reset", —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –∫—É–ª–¥–∞—É–Ω–∞ –Ω–∞ —Ç–µ–∫—É—â–µ–µ (–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–∫–∞—Ç).</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-close" onclick="closeEdit()">Cancel</button>
        <button class="btn btn-save" onclick="saveData()">üíæ SAVE CHANGES</button>
    </div>
</div>

<script>
    const RESOURCES = ["gold", "wood", "stone", "iron", "magic_crystals", "ores", "food"];
    let currentUser = null;
    let globalStatus = { isAdmin: false, isVip: false };

    async function loadUsers() {
        const res = await fetch('/api/users');
        const users = await res.json();
        document.getElementById('userList').innerHTML = users.map(u => `
            <tr onclick='openEdit(${JSON.stringify(u)})'>
                <td><code>${u._id}</code></td>
                <td>@${u.username || '---'}</td>
                <td>${u.level || 0}</td>
                <td>${u.coins || 0}</td>
                <td>${u.is_vip ? '‚≠ê VIP' : 'User'}</td>
                <td>${u.messages || 0}</td>
            </tr>
        `).join('');
    }

    async function openEdit(u) {
        currentUser = JSON.parse(JSON.stringify(u)); // –ì–ª—É–±–æ–∫–∞—è –∫–æ–ø–∏—è
        
        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π
        document.getElementById('v-id').value = u._id;
        document.getElementById('v-user').value = u.username || '';
        document.getElementById('v-coins').value = u.coins || 0;
        document.getElementById('v-lvl').value = u.level || 0;

        // –†–µ—Å—É—Ä—Å—ã
        const resGrid = document.getElementById('resGrid');
        resGrid.innerHTML = RESOURCES.map(r => `
            <div>
                <label>${r}</label>
                <input type="number" value="${u.resources?.[r] || 0}" data-res="${r}">
            </div>
        `).join('');

        // –ò–ò
        document.getElementById('ai-name').value = u.ai_profile?.name || '';
        document.getElementById('ai-rel').value = u.ai_profile?.relationship_level || 0;
        document.getElementById('ai-mood').value = u.ai_profile?.mood || '';

        // –ê—á–∏–≤–∫–∏ –∏ –∫—É–ª–¥–∞—É–Ω—ã
        renderAchievements();
        renderCooldowns();
        
        // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–π
        fetchGlobalStatus(u._id);

        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editForm').style.display = 'flex';
    }

    // --- –õ–û–ì–ò–ö–ê –ê–ß–ò–í–û–ö ---
    function renderAchievements() {
        const box = document.getElementById('achievementsContainer');
        const achs = currentUser.achievements || [];
        box.innerHTML = achs.map((a, i) => `
            <div class="tag-editable">
                ${a} <span class="remove" onclick="removeAchievement(${i})">√ó</span>
            </div>
        `).join('');
    }

    function addAchievement() {
        const input = document.getElementById('new-ach-input');
        if (!input.value) return;
        if (!currentUser.achievements) currentUser.achievements = [];
        currentUser.achievements.push(input.value);
        input.value = '';
        renderAchievements();
    }

    function removeAchievement(index) {
        currentUser.achievements.splice(index, 1);
        renderAchievements();
    }

    // --- –õ–û–ì–ò–ö–ê –ö–£–õ–î–ê–£–ù–û–í ---
    function renderCooldowns() {
        const box = document.getElementById('cooldownsList');
        const cds = currentUser.cooldowns || {};
        if (Object.keys(cds).length === 0) { box.innerHTML = "No active cooldowns"; return; }
        
        box.innerHTML = Object.entries(cds).map(([key, val]) => {
            const date = new Date(val?.$date || val);
            const isActive = date > new Date();
            return `
                <div class="cd-item">
                    <div>
                        <b style="color:var(--accent)">${key}</b><br>
                        <small style="color:#666">${date.toLocaleString()}</small>
                    </div>
                    <button class="btn btn-close" style="padding:4px 8px; font-size:10px;" onclick="resetCooldown('${key}')">RESET</button>
                </div>
            `;
        }).join('');
    }

    function resetCooldown(key) {
        currentUser.cooldowns[key] = new Date().toISOString();
        renderCooldowns();
    }

    // --- VIP –ò ADMIN –°–¢–ê–¢–£–° ---
    async function fetchGlobalStatus(id) {
        const res = await fetch(`/api/user-status/${id}`);
        const data = await res.json();
        globalStatus = data;

        const vipText = document.getElementById('vipStatusText');
        if (data.isVip) {
            vipText.innerHTML = `<b style="color:var(--vip)">ACTIVE</b> (until ${new Date(data.vipExpires).toLocaleDateString()})`;
        } else {
            vipText.innerHTML = `<span style="color:#666">No VIP</span>`;
        }

        const adminText = document.getElementById('adminStatusText');
        const adminBtn = document.getElementById('adminToggleBtn');
        if (data.isAdmin) {
            adminText.innerHTML = `<b style="color:var(--danger)">ADMINISTRATOR</b>`;
            adminBtn.innerText = "Remove Admin Rights";
        } else {
            adminText.innerHTML = `<span style="color:#666">Regular User</span>`;
            adminBtn.innerText = "Grant Admin Rights";
        }
    }

    async function handleSetVip() {
        const days = document.getElementById('vip-days').value;
        const res = await fetch('/api/set-vip', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: currentUser._id, days })
        });
        if (res.ok) { alert("VIP Updated!"); fetchGlobalStatus(currentUser._id); }
    }

    async function handleToggleAdmin() {
        const action = globalStatus.isAdmin ? 'remove' : 'add';
        const res = await fetch('/api/set-admin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: currentUser._id, action })
        });
        if (res.ok) fetchGlobalStatus(currentUser._id);
    }

    // --- –°–û–•–†–ê–ù–ï–ù–ò–ï ---
    async function saveData() {
        const update = {
            username: document.getElementById('v-user').value,
            coins: Number(document.getElementById('v-coins').value),
            level: Number(document.getElementById('v-lvl').value),
            achievements: currentUser.achievements,
            cooldowns: currentUser.cooldowns,
            "ai_profile.name": document.getElementById('ai-name').value,
            "ai_profile.relationship_level": Number(document.getElementById('ai-rel').value),
            "ai_profile.mood": document.getElementById('ai-mood').value,
        };

        document.querySelectorAll('[data-res]').forEach(i => {
            update[`resources.${i.dataset.res}`] = Number(i.value);
        });

        const res = await fetch('/api/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: currentUser._id, updateData: update })
        });

        if (res.ok) { closeEdit(); loadUsers(); }
    }

    function openTab(e, n) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(n).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function closeEdit() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editForm').style.display = 'none';
    }

    loadUsers();
</script>
</body>
</html>
