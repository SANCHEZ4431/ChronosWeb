<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chronos Master Control</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Fira+Code&display=swap" rel="stylesheet">

<style>
:root{
--accent:#00f7ff;
--accent2:#7c3aed;
--danger:#ff3366;
--vip:#facc15;
--admin:#ef4444;
--text:#e5e7eb;
--text-dim:#94a3b8;
}

body{
margin:0;
font-family:Inter;
background:#05050a;
color:var(--text);
overflow-x:hidden;
}

.bg-grid,.scanlines{pointer-events:none;position:fixed;inset:0;z-index:-1;}
.bg-grid{
background:
linear-gradient(rgba(0,255,255,0.05) 1px, transparent 1px),
linear-gradient(90deg, rgba(0,255,255,0.05) 1px, transparent 1px);
background-size:60px 60px;
animation:gridMove 30s linear infinite;
}
@keyframes gridMove{to{transform:translateY(60px)}}

.scanlines{
background:repeating-linear-gradient(to bottom,transparent 0,transparent 2px,rgba(0,255,255,.04) 3px);
animation:scanMove 8s linear infinite;
}
@keyframes scanMove{to{background-position:0 200px}}

.container{max-width:1500px;margin:auto;padding:30px;position:relative;z-index:5;}

header{
display:flex;justify-content:space-between;align-items:center;
background:rgba(255,255,255,0.04);
border:1px solid rgba(255,255,255,0.1);
border-radius:20px;padding:20px;
box-shadow:0 0 40px rgba(0,255,255,.2);
}

.logo h1{
margin:0;
background:linear-gradient(90deg,#fff,var(--accent));
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

.stat-pill{background:rgba(255,255,255,.08);padding:8px 14px;border-radius:999px;font-size:12px;}

.table-card{
margin-top:20px;
background:rgba(255,255,255,.03);
border-radius:20px;
overflow:hidden;
border:1px solid rgba(255,255,255,.1);
}

table{width:100%;border-collapse:collapse;}
th,td{padding:14px;}
th{color:var(--text-dim);font-size:11px;text-transform:uppercase;background:rgba(255,255,255,.03);}
tr:hover td{background:rgba(0,255,255,.05);cursor:pointer;}

.avatar-stub{
width:34px;height:34px;border-radius:50%;
background:linear-gradient(135deg,var(--accent),var(--accent2));
display:flex;align-items:center;justify-content:center;
font-weight:800;color:black;
}

.badge{padding:3px 8px;border-radius:999px;font-size:10px;font-weight:800;}
.badge-vip{background:gold;color:black;}
.badge-admin{background:red;color:white;}

#overlay{
display:none;
position:fixed;
inset:0;
background:rgba(0,0,0,.8);
backdrop-filter:blur(4px);
z-index:1000;
}

#editForm{
display:none;
position:fixed;
top:50%;left:50%;
transform:translate(-50%,-50%);
width:1200px;height:90vh;
background:#0f0f1e;
border-radius:24px;
z-index:1001;
box-shadow:0 0 120px rgba(0,255,255,.3);
animation:modalOpen .4s ease;
}

@keyframes modalOpen{
from{opacity:0;transform:translate(-50%,-60%) scale(.9)}
to{opacity:1;transform:translate(-50%,-50%) scale(1)}
}

.tabs-header{display:flex;background:#111;padding:10px;}
.tab-btn{background:none;border:none;color:var(--text-dim);padding:12px 20px;cursor:pointer;}
.tab-btn.active{color:var(--accent);box-shadow:inset 0 -3px 0 var(--accent);}

.modal-scrollbox{padding:20px;overflow-y:auto;height:calc(100% - 120px);}
.tab-content{display:none;}
.tab-content.active{display:block;}

.editor-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;}
.card-box{background:#111;border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,.1);}

input,select,textarea{
width:100%;
padding:10px;
background:#000;
border:1px solid rgba(255,255,255,.2);
color:white;border-radius:10px;
}

.btn{padding:12px 20px;border:none;border-radius:12px;cursor:pointer;font-weight:700;}
.btn-save{background:linear-gradient(135deg,var(--accent),var(--accent2));color:black;}
.btn-close{background:#222;color:white;}

.inv-wrapper{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;}
.item-tile{background:#000;padding:15px;border-left:4px solid var(--accent);border-radius:12px;position:relative;}

#toast{
position:fixed;bottom:20px;right:20px;
background:#111;padding:15px 25px;border-left:4px solid var(--accent);
border-radius:12px;transform:translateX(200%);transition:.5s;z-index:9999;
}
#toast.visible{transform:translateX(0);}
</style>
</head>

<body>
<div class="bg-grid"></div>
<div class="scanlines"></div>

<div class="container">
    <header>
        <div class="logo">
            <h1>Chronos Master Control</h1>
        </div>
        <div class="stats-overview">
            <div class="stat-pill">Users: <span id="count-users">0</span></div>
            <div class="stat-pill">VIP: <span id="count-vips">0</span></div>
            <button class="btn btn-save" style="padding: 8px 15px; font-size: 12px;" onclick="loadUsers()">üîÑ Reload</button>
            <button class="btn btn-close" style="padding: 8px 15px; font-size: 12px; background: rgba(255,51,102,0.1); border: 1px solid var(--danger); color: var(--danger);" onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <div class="search-bar" style="margin-bottom: 20px; display: flex; gap: 15px;">
        <div style="position: relative; flex: 1;">
            <input type="text" id="userSearch" placeholder="Search by ID or Username (e.g. @sanchez or 505952...)" 
                   style="padding-left: 45px; height: 50px; background: var(--surface); border: 1px solid rgba(255,255,255,0.1);"
                   oninput="filterUsers()">
            <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 18px;">üîç</span>
        </div>
        <div class="stat-pill" style="display: flex; align-items: center; justify-content: center; min-width: 150px;">
            Found: <span id="count-found" style="margin-left: 8px;">0</span>
        </div>
    </div>

    <div class="table-card">
        <table id="userTable">
            <thead>
                <tr>
                    <th>Identifier</th>
                    <th>User Profile</th>
                    <th>Level / XP</th>
                    <th>Finances</th>
                    <th>Resources</th>
                    <th>Nova AI</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="userList">
                <tr><td colspan="7" style="text-align:center; padding: 60px; color: var(--text-dim);">Connecting to Database Nexus...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="overlay" onclick="closeEdit()"></div>

<div id="editForm">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab(event, 'p-main')">üìä Profile</button>
        <button class="tab-btn" onclick="openTab(event, 'p-res')">üì¶ Resources</button>
        <button class="tab-btn" onclick="openTab(event, 'p-skills')">‚ö° Skills</button>
        <button class="tab-btn" onclick="openTab(event, 'p-inv')">üéí Inventory</button>
        <button class="tab-btn" onclick="openTab(event, 'p-nova')">ü§ñ Nova AI</button>
        <button class="tab-btn" onclick="openTab(event, 'p-system')">‚öôÔ∏è System</button>
    </div>

    <div class="modal-scrollbox">
        <div id="p-main" class="tab-content active">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üë§ Identity</h3>
                    <label>Internal ID</label><input type="text" id="v-id" disabled>
                    <label>Alias / Username</label><input type="text" id="v-user">
                    <label>Current Level</label><input type="number" id="v-lvl">
                    <label>Experience Points</label><input type="number" id="v-xp">
                </div>
                <div class="card-box">
                    <h3>üíé Economics</h3>
                    <label>Gold Coins</label><input type="number" id="v-coins">
                    <label>Void Essence</label><input type="number" id="v-essence">
                    <label>Clan Association</label><input type="text" id="v-clan">
                </div>
                <div class="card-box">
                    <h3>üõ°Ô∏è Privileges</h3>
                    <label>Admin Rights</label>
                    <select id="v-is-admin" onchange="toggleAdmin(this.value)">
                        <option value="false">Standard User</option>
                        <option value="true">System Administrator</option>
                    </select>
                
                    <label>VIP Subscription Control</label>
                    <div id="vip-info" style="font-size: 11px; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;"></div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="number" id="vip-days-input" value="30" style="flex: 1;" placeholder="Days">
                        <button class="btn btn-save" style="flex: 2; padding: 10px;" onclick="grantVipCustom()">Grant VIP</button>
                    </div>
                    
                    <button class="btn btn-close" style="width:100%; color: var(--danger); border: 1px solid rgba(255,51,102,0.3);" onclick="revokeVip()">Revoke VIP Status</button>
                </div>
            </div>
        </div>

        <div id="p-res" class="tab-content">
            <div class="card-box">
                <h3>üì¶ Raw Materials</h3>
                <div id="dynamic-res-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 20px;"></div>
            </div>
        </div>

        <div id="p-skills" class="tab-content">
            <div class="card-box">
                <h3>‚ö° Active Skill Levels</h3>
                <div id="dynamic-skills-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 20px;"></div>
            </div>
        </div>

        <div id="p-inv" class="tab-content">
            <div class="card-box" style="margin-bottom:20px; background: rgba(0, 229, 255, 0.05);">
                <h3>‚ú® Item Injection</h3>
                <div style="display:flex; gap:15px;">
                    <select id="add-item-sel" style="flex:2;">
                        </select>
                    <input type="number" id="add-item-qty" value="1" style="flex:0.5;">
                    <button class="btn btn-save" onclick="addItemToInv()">Inject</button>
                </div>
            </div>
            <div id="inv-list" class="inv-wrapper"></div>
        </div>

        <div id="p-nova" class="tab-content">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üß† Personality</h3>
                    <label>Nova Name</label><input type="text" id="ai-name">
                    <label>Relationship Level</label><input type="number" id="ai-rel">
                    <label>Gender/Type</label><input type="text" id="ai-gender">
                    <label>Speech Style</label><textarea id="ai-style" rows="3"></textarea>
                </div>
                <div class="card-box" style="grid-column: span 2;">
                    <h3>üéûÔ∏è Recent Memory</h3>
                    <div id="ai-logs" style="height:350px; background:#000; border-radius:10px; padding:15px; overflow-y:auto; font-family:'Fira Code'; font-size:12px;"></div>
                </div>
            </div>
        </div>

        <div id="p-system" class="tab-content">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üö´ Access Control</h3>
                    <label>Ban Status</label>
                    <select id="v-banned">
                        <option value="false">No Restriction</option>
                        <option value="true">BANNED</option>
                    </select>
                    <label>Warn Count</label><input type="number" id="v-warns">
                </div>
                <div class="card-box">
                    <h3>üïí Cooldowns</h3>
                    <div id="cd-list" style="font-size:12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button class="btn btn-close" onclick="closeEdit()">Discard</button>
        <button class="btn btn-save" onclick="processSave()">üíæ Commit Changes</button>
    </div>
</div>

<div id="toast">Operation Successful</div>

<script>
    const RES_TYPES = ["gold", "wood", "stone", "iron", "magic_crystals", "ores", "fabric", "food", "rare_artifacts"];
    const SKILL_TYPES = ["exp_boost", "resource_gain", "luck", "gold_gain", "wisdom", "cooldown_reduction", "pet_bonus"];

    let allUsers = [];
    let activeUser = null;

    async function loadUsers() {
        try {
            const r = await fetch('/api/users');
            allUsers = await r.json();
            document.getElementById('userSearch').value = ''; // –°–±—Ä–æ—Å –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
            renderTable();
            updateStats();
            console.log("Data refreshed from DB");
        } catch(e) { 
            console.error("API Error", e); 
        }
    }

    function filterUsers() {
        const query = document.getElementById('userSearch').value.toLowerCase().trim();
        
        // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ—Ö
        if (!query) {
            renderTable(allUsers);
            return;
        }
    
        const filtered = allUsers.filter(u => {
            const idMatch = String(u._id).includes(query);
            const nameMatch = (u.username || "").toLowerCase().includes(query.replace('@', ''));
            return idMatch || nameMatch;
        });
    
        renderTable(filtered);
        document.getElementById('count-found').innerText = filtered.length;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—É—é)
    // –¢–µ–ø–µ—Ä—å –æ–Ω–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –ø–æ–∏—Å–∫–∞)
    function renderTable(dataToRender = allUsers) {
        const body = document.getElementById('userList');
        
        if (dataToRender.length === 0) {
            body.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 60px; color: var(--text-dim);">No users found matching your request.</td></tr>`;
            return;
        }
    
        body.innerHTML = dataToRender.map((u) => {
            // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ allUsers –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ editUser
            const originalIndex = allUsers.findIndex(original => original._id === u._id);
            
            const isAdmin = u.is_admin === true;
            const isVip = u.is_vip === true; 
            const isBanned = u.banned === true;
            
            return `
            <tr onclick="editUser(${originalIndex})">
                <td data-label="ID" class="user-id">#${u._id}</td>
                <td data-label="User">
                    <div class="user-cell">
                        <div class="avatar-stub">${(u.username || 'U').charAt(0).toUpperCase()}</div>
                        <b>@${u.username || 'NoName'}</b>
                    </div>
                </td>
                <td data-label="Level">Lvl ${u.level || 1} <br><small>XP: ${u.exp || u.xp || 0}</small></td>
                <td data-label="Money">üí∞ ${u.coins?.toLocaleString() || 0}</td>
                <td data-label="Resources">üì¶ ${Object.values(u.resources || {}).reduce((a,b)=>a+b, 0)}</td>
                <td data-label="AI">${u.ai_profile?.name || 'Nova'}</td>
                <td data-label="Status">
                    ${isBanned ? '<span class="badge" style="background:var(--danger)">Banned</span>' : ''}
                    ${isAdmin ? '<span class="badge badge-admin">Developer</span>' : ''}
                    ${isVip ? '<span class="badge badge-vip">VIP</span>' : ''}
                    ${!isAdmin && !isVip && !isBanned ? '<span class="badge" style="background:rgba(255,255,255,0.05)">User</span>' : ''}
                </td>
            </tr>`;
        }).join('');
    
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
        document.getElementById('count-found').innerText = dataToRender.length;
    }

    function editUser(index) {
        activeUser = JSON.parse(JSON.stringify(allUsers[index]));
        
        document.getElementById('v-id').value = activeUser._id;
        document.getElementById('v-user').value = activeUser.username || '';
        document.getElementById('v-lvl').value = activeUser.level || 1;
        document.getElementById('v-xp').value = activeUser.exp || activeUser.xp || 0;
        document.getElementById('v-coins').value = activeUser.coins || 0;
        document.getElementById('v-essence').value = activeUser.essence || 0;
        document.getElementById('v-is-admin').value = String(activeUser.is_admin || false);
        document.getElementById('v-clan').value = activeUser.clan_id || '';
        document.getElementById('v-banned').value = String(activeUser.banned || false);
        document.getElementById('v-warns').value = activeUser.warns || 0;

        updateVipUI();

        // Resources Tab
        const resGrid = document.getElementById('dynamic-res-grid');
        resGrid.innerHTML = RES_TYPES.map(rt => `
            <div>
                <label>${rt.replace(/_/g,' ')}</label>
                <input type="number" value="${activeUser.resources?.[rt] || 0}" data-res-key="${rt}">
            </div>
        `).join('');

        // Skills Tab
        const skillGrid = document.getElementById('dynamic-skills-grid');
        skillGrid.innerHTML = SKILL_TYPES.map(st => `
            <div>
                <label>${st.replace(/_/g,' ')}</label>
                <input type="number" value="${activeUser.skills?.[st] || 0}" data-skill-key="${st}">
            </div>
        `).join('');

        // AI 
        const ai = activeUser.ai_profile || {};
        document.getElementById('ai-name').value = ai.name || 'Nova';
        document.getElementById('ai-rel').value = ai.relationship_level || 0;
        document.getElementById('ai-gender').value = ai.gender || '';
        document.getElementById('ai-style').value = ai.speech_style || '';

        // AI History
        const aiLogs = document.getElementById('ai-logs');
        if (activeUser.ai_history && activeUser.ai_history.length > 0) {
            aiLogs.innerHTML = activeUser.ai_history.map(msg => `
                <div style="margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px;">
                    <span style="color: var(--accent)">[${msg.role?.toUpperCase()}]:</span> 
                    <span style="color: #ccc">${msg.content}</span>
                </div>
            `).join('');
        } else { aiLogs.innerHTML = 'Memory Empty'; }

        // Cooldowns (–ë–ï–ó —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
        const cdList = document.getElementById('cd-list');
        const cds = activeUser.cooldowns || {};
        
        if (Object.keys(cds).length > 0) {
            cdList.innerHTML = Object.entries(cds).map(([k, v]) => {
                const dateValue = (v && typeof v === 'object' && v.$date) ? v.$date : v;
        
                if (!dateValue) {
                    return `<div style="color:var(--success)"><b>${k}:</b> Ready</div>`;
                }
        
                const date = new Date(dateValue);
                if (isNaN(date.getTime())) {
                    return `<div style="color:var(--text-dim)"><b>${k}:</b> Unknown format</div>`;
                }
        
                // –ù–ò–ö–ê–ö–û–ì–û Date.now()
                return `<div style="color:var(--danger); margin-bottom: 8px; font-size: 13px;">
                    <b>${k}:</b> ‚è≥ ${date.toLocaleString()}
                </div>`;
            }).join('');
        } else {
            cdList.innerHTML = 'No active cooldowns';
        }
        // --- –ö–æ–Ω–µ—Ü –±–ª–æ–∫–∞ ---
        renderInv();
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editForm').style.display = 'flex';
    }
        
    function updateVipUI() {
        const vipInfo = document.getElementById('vip-info');
        // –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
        if (activeUser.is_vip) {
            const expiryDate = activeUser.vip_until ? new Date(activeUser.vip_until).toLocaleDateString() : "Lifetime";
            vipInfo.innerHTML = `<b style="color:var(--vip)">‚úÖ VIP ACTIVE</b><br>Expires: ${expiryDate}`;
        } else {
            vipInfo.innerHTML = `<b style="color:var(--text-dim)">‚ùå VIP INACTIVE</b>`;
        }
    }

    async function grantVipCustom() {
        const days = document.getElementById('vip-days-input').value;
        if (!days || days <= 0) return alert("Please enter valid number of days");
    
        try {
            const res = await fetch('/api/set-vip', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    user_id: activeUser._id, 
                    days: parseInt(days) 
                })
            });
    
            if(res.ok) {
                showToast(`VIP granted for ${days} days`);
                // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –¥–ª—è UI, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + parseInt(days));
                activeUser.is_vip = true;
                activeUser.vip_until = newDate;
                updateVipUI();
            }
        } catch(e) {
            alert("Error updating VIP status");
        }
    }
    async function revokeVip() {
        if(!confirm("Are you sure you want to revoke VIP status?")) return;
        activeUser.is_vip = false;
        activeUser.vip_until = null;
        // –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π API
        processSave();
    }

    async function toggleAdmin(val) {
        const action = val === 'true' ? 'add' : 'remove';
        try {
            const res = await fetch('/api/set-admin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: activeUser._id, action: action })
            });
            if(res.ok) showToast(`Admin status: ${val}`);
        } catch(e) { console.error(e); }
    }

    function renderInv() {
        const box = document.getElementById('inv-list');
        box.innerHTML = '';
        const items = activeUser.inventory || {};
        
        for (let key in items) {
            let amount, rarity;
    
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–º (–∫–∞–∫ Crown of Mastery) –∏–ª–∏ —á–∏—Å–ª–æ–º (–∫–∞–∫ shadow_note)
            if (typeof items[key] === 'object' && items[key] !== null) {
                amount = items[key].amount || 0;
                rarity = items[key].rarity || 'common';
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ (—Å–ª—É—á–∞–π shadow_note: 5)
                amount = items[key];
                rarity = 'common'; 
            }
    
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ inventory
            if (['exp', 'coins', 'resources'].includes(key)) continue;
    
            box.innerHTML += `
                <div class="item-tile ${rarity}">
                    <span class="name">${key}</span>
                    <span class="val">x${amount}</span>
                    <button onclick="remItem('${key}')" style="position:absolute; top:5px; right:5px; background:none; border:none; color:red; cursor:pointer; font-size: 18px;">√ó</button>
                </div>
            `;
        }
    }

    // 1. –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    const AVAILABLE_ITEMS = [
        {"name": "Talisman of Knowledge", "rarity": "common"},
        {"name": "Coin Bank", "rarity": "common"},
        {"name": "Traveler‚Äôs Compass", "rarity": "common"},
        {"name": "Wooden Ring", "rarity": "common"},
        {"name": "Lucky Charm", "rarity": "common"},
        {"name": "Energy Drink", "rarity": "rare"},
        {"name": "Amulet of Wisdom", "rarity": "rare"},
        {"name": "Silver Quill", "rarity": "rare"},
        {"name": "Ring of Focus", "rarity": "rare"},
        {"name": "Scholar‚Äôs Book", "rarity": "rare"},
        {"name": "Golden Purse", "rarity": "epic"},
        {"name": "Crystal of Luck", "rarity": "epic"},
        {"name": "Cloak of Insight", "rarity": "epic"},
        {"name": "Orb of Fortune", "rarity": "epic"},
        {"name": "Crown of Clarity", "rarity": "epic"},
        {"name": "Crown of Mastery", "rarity": "legendary"},
        {"name": "Philosopher's Stone", "rarity": "legendary"},
        {"name": "Eternal Flame", "rarity": "legendary"},
        {"name": "Timekeeper‚Äôs Hourglass", "rarity": "legendary"},
        {"name": "Book of Eternity", "rarity": "legendary"},
        {"name": "shadow_note", "rarity": "common"}
    ];
    
    // 2. –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ (–≤—ã–∑–æ–≤–∏—Ç–µ –µ—ë –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    function initItemSelector() {
        const sel = document.getElementById('add-item-sel');
        sel.innerHTML = AVAILABLE_ITEMS.map(item => {
            // –ï—Å–ª–∏ rarity –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º 'common' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const rarityText = (item.rarity || 'common').toUpperCase(); 
            return `<option value="${item.name}">${item.name} (${rarityText})</option>`;
        }).join('');
    }
    
    // 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function addItemToInv() {
        const name = document.getElementById('add-item-sel').value;
        const qty = parseInt(document.getElementById('add-item-qty').value);
        
        // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–¥–º–µ—Ç–µ
        const itemData = AVAILABLE_ITEMS.find(i => i.name === name);
        const rarity = itemData && itemData.rarity ? itemData.rarity : 'common';
        
        if(!activeUser.inventory) activeUser.inventory = {};
        
        // –ï—Å–ª–∏ —ç—Ç–æ shadow_note –∏ –æ–Ω –≤ –±–∞–∑–µ —Ö—Ä–∞–Ω–∏—Ç—Å—è –∫–∞–∫ —á–∏—Å–ª–æ, 
        // –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ –≤ –æ–±—ä–µ–∫—Ç –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        if (typeof activeUser.inventory[name] === 'number') {
            activeUser.inventory[name] = { 
                amount: activeUser.inventory[name] + qty, 
                rarity: rarity 
            };
        } else if (activeUser.inventory[name]) {
            activeUser.inventory[name].amount += qty;
        } else {
            activeUser.inventory[name] = { 
                amount: qty, 
                rarity: rarity 
            };
        }
        
        renderInv();
        showToast(`Injected: ${name} x${qty}`);
    }
    
    // –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–∑–≤–∞—Ç—å initItemSelector() –≤ window.onload –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ —Å–∫—Ä–∏–ø—Ç–∞
    window.addEventListener('load', () => {
        initItemSelector();
        loadUsers();
    });

    function remItem(key) {
        delete activeUser.inventory[key];
        renderInv();
    }

    async function processSave() {
        const update = {
            username: document.getElementById('v-user').value,
            level: Number(document.getElementById('v-lvl').value),
            exp: Number(document.getElementById('v-xp').value),
            coins: Number(document.getElementById('v-coins').value),
            essence: Number(document.getElementById('v-essence').value),
            clan_id: document.getElementById('v-clan').value,
            is_admin: document.getElementById('v-is-admin').value === 'true',
            banned: document.getElementById('v-banned').value === 'true',
            warns: Number(document.getElementById('v-warns').value),
            is_vip: activeUser.is_vip,
            vip_until: activeUser.vip_until,
            inventory: activeUser.inventory,
            "ai_profile.name": document.getElementById('ai-name').value,
            "ai_profile.relationship_level": Number(document.getElementById('ai-rel').value),
            "ai_profile.gender": document.getElementById('ai-gender').value,
            "ai_profile.speech_style": document.getElementById('ai-style').value
        };

        document.querySelectorAll('[data-res-key]').forEach(el => {
            update[`resources.${el.dataset.resKey}`] = Number(el.value);
        });
        document.querySelectorAll('[data-skill-key]').forEach(el => {
            update[`skills.${el.dataset.skillKey}`] = Number(el.value);
        });

        const res = await fetch('/api/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: activeUser._id, updateData: update })
        });

        if(res.ok) {
            showToast("Sync Complete");
            closeEdit();
            loadUsers();
        }
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function closeEdit() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editForm').style.display = 'none';
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 3000);
    }

    function updateStats() {
        document.getElementById('count-users').innerText = allUsers.length;
        document.getElementById('count-vips').innerText = allUsers.filter(u => u.is_vip || (u.vip_until && new Date(u.vip_until) > new Date())).length;
    }

    loadUsers();

    async function logout() {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏?")) return;
    
        try {
            const res = await fetch('/api/logout', { method: 'POST' });
            if (res.ok) {
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = '/login.html'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª–æ–≥–∏–Ω–∞
            }
        } catch (e) {
            console.error("Logout error:", e);
            // –ï—Å–ª–∏ API –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–æ, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É (—Å–µ—Ä–≤–µ—Ä —Å–∞–º –≤—ã–∫–∏–Ω–µ—Ç –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–µ—Å—Å–∏–∏)
            window.location.reload();
        }
    }
</script>
</body>
</html>
