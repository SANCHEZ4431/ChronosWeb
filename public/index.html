<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Chronos Master Control v2.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b0b14; --surface: #161625; --accent: #5da9ff; --text: #e0e0e0;
            --legendary: #ffae00; --epic: #bf40bf; --rare: #0070dd; --common: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        .container { max-width: 1300px; margin: 0 auto; }
        
        table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 12px; overflow: hidden; margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #2d2d44; }
        th { background: #1f1f35; color: var(--accent); font-size: 11px; text-transform: uppercase; }
        tr:hover { background: #1f1f35; cursor: pointer; }

        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 999; }
        #editForm {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--surface); width: 1100px; max-height: 95vh; border-radius: 20px;
            z-index: 1000; overflow: hidden; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,1);
        }

        .tabs { display: flex; background: #1f1f35; padding: 10px 20px 0; gap: 5px; }
        .tab-btn { padding: 12px 20px; border: none; background: none; color: #888; cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0; }
        .tab-btn.active { background: var(--surface); color: var(--accent); }

        .content { padding: 25px; overflow-y: auto; flex-grow: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .section { background: #1f1f35; padding: 15px; border-radius: 12px; }
        .section h4 { margin: 0 0 10px 0; color: var(--accent); font-size: 13px; text-transform: uppercase; border-bottom: 1px solid #2d2d44; padding-bottom: 5px; }

        label { display: block; font-size: 10px; color: #888; margin-top: 8px; text-transform: uppercase; }
        input, select { width: 100%; padding: 8px; margin-top: 4px; background: #0b0b14; border: 1px solid #2d2d44; color: #fff; border-radius: 5px; box-sizing: border-box; }

        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; }
        .item-card { background: #0b0b14; padding: 10px; border-radius: 8px; border-left: 4px solid #fff; position: relative; }
        .item-card.legendary { border-color: var(--legendary); }
        .item-card.epic { border-color: var(--epic); }
        .item-card.rare { border-color: var(--rare); }
        .item-card .name { font-size: 12px; font-weight: bold; display: block; }
        .item-card .count { color: var(--accent); font-size: 13px; }
        .del-btn { position: absolute; top: 5px; right: 8px; color: #ff4d4d; cursor: pointer; }

        .chat-log { background: #0b0b14; padding: 10px; border-radius: 8px; font-size: 12px; max-height: 250px; overflow-y: auto; border: 1px solid #2d2d44; }
        .msg { margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dotted #2d2d44; }
        .msg-u { color: var(--accent); }
        .msg-a { color: #ff80ab; }

        .tag { display: inline-block; background: #2d2d44; padding: 3px 8px; border-radius: 4px; font-size: 10px; margin: 2px; }
        .footer { padding: 15px 25px; background: #1f1f35; display: flex; justify-content: flex-end; gap: 10px; }
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: var(--accent); color: #000; }
        .btn-close { background: #3d3d5c; color: #fff; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--accent);">Chronos Master Control <small style="font-size: 12px; color: #666;">v2.1 Stable</small></h1>
    <table id="userTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Level</th>
                <th>Coins</th>
                <th>Essence</th>
                <th>AI Nova</th>
                <th>Messages</th>
            </tr>
        </thead>
        <tbody id="userList">
            <tr><td colspan="7" style="text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
        </tbody>
    </table>
</div>

<div id="overlay" onclick="closeEdit()"></div>

<div id="editForm">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'main')">üìä PROFILE</button>
        <button class="tab-btn" onclick="openTab(event, 'inventory')">üéí INVENTORY</button>
        <button class="tab-btn" onclick="openTab(event, 'nova')">ü§ñ NOVA AI</button>
        <button class="tab-btn" onclick="openTab(event, 'skills')">‚ö° SKILLS</button>
        <button class="tab-btn" onclick="openTab(event, 'system')">‚öôÔ∏è SYSTEM</button>
    </div>

    <div class="content">
        <div id="main" class="tab-content active">
            <div class="grid">
                <div class="section">
                    <h4>Basic Data</h4>
                    <label>Telegram ID</label><input type="text" id="v-id" disabled>
                    <label>Username</label><input type="text" id="v-user">
                    <label>Level / XP</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="v-lvl">
                        <input type="number" id="v-xp">
                    </div>
                    <label>Currency (Coins / Essence)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="v-coins">
                        <input type="number" id="v-essence">
                    </div>
                </div>
                <div class="section">
                    <h4>Resource Warehouse</h4>
                    <div id="resGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;"></div>
                </div>
                <div class="section">
                    <h4>Status & Activity</h4>
                    <label>Messages Total</label><input type="number" id="v-msgs">
                    <label>Commands Count</label><input type="number" id="v-cmds">
                    <label>Warnings</label><input type="number" id="v-warns">
                    <label>Clan ID</label><input type="text" id="v-clan">
                </div>
            </div>
            <h4 style="margin-top:20px;">üèÜ Achievements</h4>
            <div id="achievementsBox"></div>
        </div>

        <div id="inventory" class="tab-content">
            <div class="section" style="margin-bottom:15px; border: 1px solid var(--accent);">
                <h4>Give Item</h4>
                <div style="display:flex; gap:10px;">
                    <select id="add-item-name" style="flex:2;"></select>
                    <input type="number" id="add-item-amount" value="1" style="flex:0.5;">
                    <button class="btn btn-save" onclick="handleAddItem()">Add to Bag</button>
                </div>
            </div>
            <div id="inventoryList" class="inv-grid"></div>
        </div>

        <div id="nova" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h4>AI Personality</h4>
                    <label>Name</label><input type="text" id="ai-name">
                    <label>Relationship Level</label><input type="number" step="0.1" id="ai-rel">
                    <label>Age</label><input type="number" id="ai-age">
                    <label>Gender</label><input type="text" id="ai-gender">
                    <label>Mood Style</label><input type="text" id="ai-mood">
                    <label>Speech Style</label><input type="text" id="ai-speech">
                </div>
                <div class="section" style="grid-column: span 2;">
                    <h4>Memory & Chat Log</h4>
                    <div id="aiChat" class="chat-log"></div>
                    <label>Current AI Quest</label>
                    <div id="aiQuest" style="background:#0b0b14; padding:10px; border-radius:5px; border: 1px solid #2d2d44; font-size:12px; color:var(--accent); min-height: 20px;"></div>
                </div>
            </div>
        </div>

        <div id="skills" class="tab-content">
            <div id="skillsGrid" class="grid"></div>
        </div>

        <div id="system" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h4>Cooldowns</h4>
                    <div id="cdBox" style="font-size:11px;"></div>
                </div>
                <div class="section">
                    <h4>Pets</h4>
                    <div id="petsBox"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-close" onclick="closeEdit()">Cancel</button>
        <button class="btn btn-save" onclick="saveData()">üíæ UPDATE DATABASE</button>
    </div>
</div>

<script>
    const RESOURCES = ["gold", "wood", "stone", "iron", "magic_crystals", "ores", "fabric", "food", "rare_artifacts"];
    const SKILLS = ["exp_boost", "resource_gain", "cooldown_reduction", "pet_bonus", "luck", "blessing_power", "gold_gain", "expedition_speed", "artifact_luck", "wisdom"];
    const ITEMS_DB = [
        {"name": "Talisman of Knowledge", "rarity": "common"}, {"name": "Coin Bank", "rarity": "common"},
        {"name": "Traveler‚Äôs Compass", "rarity": "common"}, {"name": "Wooden Ring", "rarity": "common"},
        {"name": "Lucky Charm", "rarity": "common"}, {"name": "Energy Drink", "rarity": "rare"},
        {"name": "Amulet of Wisdom", "rarity": "rare"}, {"name": "Silver Quill", "rarity": "rare"},
        {"name": "Ring of Focus", "rarity": "rare"}, {"name": "Scholar‚Äôs Book", "rarity": "rare"},
        {"name": "Golden Purse", "rarity": "epic"}, {"name": "Crystal of Luck", "rarity": "epic"},
        {"name": "Cloak of Insight", "rarity": "epic"}, {"name": "Orb of Fortune", "rarity": "epic"},
        {"name": "Crown of Clarity", "rarity": "epic"}, {"name": "Crown of Mastery", "rarity": "legendary"},
        {"name": "Philosopher's Stone", "rarity": "legendary"}, {"name": "Eternal Flame", "rarity": "legendary"},
        {"name": "Timekeeper‚Äôs Hourglass", "rarity": "legendary"}, {"name": "Book of Eternity", "rarity": "legendary"}
    ];

    let currentUser = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    const itemSelect = document.getElementById('add-item-name');
    ITEMS_DB.forEach(i => {
        let opt = document.createElement('option');
        opt.value = i.name;
        opt.innerText = `${i.name} [${i.rarity.toUpperCase()}]`;
        itemSelect.appendChild(opt);
    });

    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            if (!res.ok) throw new Error("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (401) –∏–ª–∏ –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
            
            const users = await res.json();
            const list = document.getElementById('userList');
            
            if (!users || users.length === 0) {
                list.innerHTML = '<tr><td colspan="7" style="text-align:center;">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ</td></tr>';
                return;
            }

            list.innerHTML = users.map(u => {
                const id = u._id; 
                return `
                <tr onclick='openEdit(${JSON.stringify(u).replace(/'/g, "&apos;")})'>
                    <td><code>${id}</code></td>
                    <td><b>@${u.username || 'unknown'}</b></td>
                    <td>Lvl ${u.level || 0}</td>
                    <td>${(u.coins || 0).toLocaleString()}</td>
                    <td>${u.essence || 0}</td>
                    <td>${u.ai_profile?.name || '---'}</td>
                    <td>${u.messages || 0}</td>
                </tr>`;
            }).join('');
        } catch (e) {
            document.getElementById('userList').innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">${e.message}</td></tr>`;
        }
    }

    function openEdit(u) {
        currentUser = JSON.parse(JSON.stringify(u));
        const id = u._id;
        
        document.getElementById('v-id').value = id;
        document.getElementById('v-user').value = u.username || '';
        document.getElementById('v-lvl').value = u.level || 1;
        document.getElementById('v-xp').value = u.xp || u.exp || 0;
        document.getElementById('v-coins').value = u.coins || 0;
        document.getElementById('v-essence').value = u.essence || 0;
        document.getElementById('v-msgs').value = u.messages || 0;
        document.getElementById('v-cmds').value = u.commands_count || 0;
        document.getElementById('v-warns').value = u.warns || 0;
        document.getElementById('v-clan').value = u.clan_id || '';

        // –†–µ—Å—É—Ä—Å—ã
        const resGrid = document.getElementById('resGrid');
        resGrid.innerHTML = RESOURCES.map(r => `
            <div>
                <label>${r.replace(/_/g,' ')}</label>
                <input type="number" value="${u.resources?.[r] || 0}" data-res="${r}">
            </div>
        `).join('');

        // –°–∫–∏–ª–ª—ã
        const skillGrid = document.getElementById('skillsGrid');
        skillGrid.innerHTML = SKILLS.map(s => `
            <div class="section">
                <label>${s.replace(/_/g,' ')}</label>
                <input type="number" value="${u.skills?.[s] || 0}" data-skill="${s}">
            </div>
        `).join('');

        // –ò–ò
        const ai = u.ai_profile || {};
        document.getElementById('ai-name').value = ai.name || '';
        document.getElementById('ai-rel').value = ai.relationship_level || 0;
        document.getElementById('ai-age').value = ai.age || 0;
        document.getElementById('ai-gender').value = ai.gender || '';
        document.getElementById('ai-mood').value = ai.mood || '';
        document.getElementById('ai-speech').value = ai.speech_style || '';
        document.getElementById('aiQuest').innerText = ai.quest?.meta?.text || 'No active quest';
        
        document.getElementById('aiChat').innerHTML = (u.ai_history || []).map(m => `
            <div class="msg"><b class="msg-${m.role === 'user' ? 'u':'a'}">${m.role.toUpperCase()}:</b> ${m.content}</div>
        `).join('');

        renderInventory();
        document.getElementById('achievementsBox').innerHTML = (u.achievements || []).map(a => `<span class="tag">${a}</span>`).join('');
        document.getElementById('petsBox').innerHTML = (u.pets || []).map(p => `<span class="tag" style="border-color:var(--accent); border: 1px solid;">üêæ ${p}</span>`).join('');

        // –ö—É–ª–¥–∞—É–Ω—ã
        document.getElementById('cdBox').innerHTML = Object.entries(u.cooldowns || {}).map(([k, v]) => {
            const dateVal = v?.$date || v;
            const date = new Date(dateVal);
            return `<div style="margin-bottom:4px;">‚è± <b>${k}:</b> ${isNaN(date) ? 'Active' : date.toLocaleString()}</div>`;
        }).join('');

        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editForm').style.display = 'flex';
    }

    function renderInventory() {
        const list = document.getElementById('inventoryList');
        list.innerHTML = '';
        const inv = currentUser.inventory || {};
        for (const [name, data] of Object.entries(inv)) {
            const rarityClass = data.rarity || 'common';
            list.innerHTML += `
                <div class="item-card ${rarityClass}">
                    <span class="del-btn" onclick="handleRemoveItem('${name}')">‚úñ</span>
                    <span class="name">${name}</span>
                    <span class="count">x${data.amount || 0}</span>
                </div>`;
        }
    }

    function handleAddItem() {
        const name = document.getElementById('add-item-name').value;
        const amount = parseInt(document.getElementById('add-item-amount').value);
        const meta = ITEMS_DB.find(i => i.name === name);
        
        if (!currentUser.inventory) currentUser.inventory = {};
        if (currentUser.inventory[name]) {
            currentUser.inventory[name].amount += amount;
        } else {
            currentUser.inventory[name] = { amount: amount, rarity: meta.rarity };
        }
        renderInventory();
    }

    function handleRemoveItem(name) {
        if (confirm(`–£–¥–∞–ª–∏—Ç—å ${name} –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è?`)) {
            delete currentUser.inventory[name];
            renderInventory();
        }
    }

    async function saveData() {
        const update = {
            username: document.getElementById('v-user').value,
            level: Number(document.getElementById('v-lvl').value),
            xp: Number(document.getElementById('v-xp').value),
            coins: Number(document.getElementById('v-coins').value),
            essence: Number(document.getElementById('v-essence').value),
            messages: Number(document.getElementById('v-msgs').value),
            commands_count: Number(document.getElementById('v-cmds').value),
            warns: Number(document.getElementById('v-warns').value),
            clan_id: document.getElementById('v-clan').value,
            inventory: currentUser.inventory,
            "ai_profile.name": document.getElementById('ai-name').value,
            "ai_profile.relationship_level": Number(document.getElementById('ai-rel').value),
            "ai_profile.age": Number(document.getElementById('ai-age').value),
            "ai_profile.gender": document.getElementById('ai-gender').value,
            "ai_profile.mood": document.getElementById('ai-mood').value,
            "ai_profile.speech_style": document.getElementById('ai-speech').value,
        };

        document.querySelectorAll('[data-res]').forEach(i => update[`resources.${i.dataset.res}`] = Number(i.value));
        document.querySelectorAll('[data-skill]').forEach(i => update[`skills.${i.dataset.skill}`] = Number(i.value));

        try {
            const res = await fetch('/api/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: currentUser._id, updateData: update })
            });

            if (res.ok) { 
                alert("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
                closeEdit(); 
                loadUsers(); 
            } else {
                const err = await res.json();
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: " + err.error);
            }
        } catch (e) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + e.message);
        }
    }

    function openTab(evt, name) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    function closeEdit() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editForm').style.display = 'none';
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadUsers();
</script>
</body>
</html>
