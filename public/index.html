<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos Master Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f1a;
            --surface: #1a1a2e;
            --accent: #5da9ff;
            --text: #e0e0e0;
            --legendary: #ff8000;
            --epic: #a335ee;
            --rare: #0070dd;
            --common: #ffffff;
            --danger: #ff4d4d;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0; padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }
        
        /* –¢–∞–±–ª–∏—Ü–∞ */
        table { width: 100%; border-collapse: collapse; background: var(--surface); border-radius: 12px; overflow: hidden; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #2d2d44; }
        th { background: #252545; color: var(--accent); text-transform: uppercase; font-size: 12px; }
        tr:hover { background: #252545; cursor: pointer; }

        /* –ú–æ–¥–∞–ª–∫–∞ */
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; }
        #editForm {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: var(--surface); width: 950px; max-height: 90vh; border-radius: 20px;
            box-shadow: 0 0 40px rgba(0,0,0,0.5); z-index: 1000; overflow: hidden; flex-direction: column;
        }

        /* –¢–∞–±—ã */
        .tabs { display: flex; background: #252545; padding: 10px 20px 0; gap: 10px; }
        .tab-btn {
            padding: 12px 20px; border: none; background: none; color: #888;
            cursor: pointer; border-radius: 8px 8px 0 0; font-weight: 600;
        }
        .tab-btn.active { background: var(--surface); color: var(--accent); }

        .content { padding: 25px; overflow-y: auto; flex-grow: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* –°–µ—Ç–∫–∏ */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .section { background: #252545; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .section h4 { margin-top: 0; color: var(--accent); border-bottom: 1px solid #3d3d5c; padding-bottom: 10px; margin-bottom: 15px; }
        
        label { display: block; font-size: 11px; color: #888; margin-top: 10px; text-transform: uppercase; }
        input, select {
            width: 100%; padding: 10px; margin-top: 5px; background: #0f0f1a;
            border: 1px solid #3d3d5c; color: #fff; border-radius: 6px; box-sizing: border-box;
        }

        /* –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å */
        .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; margin-top: 15px; }
        .item-card {
            background: #0f0f1a; padding: 12px; border-radius: 8px; border-left: 4px solid #fff;
            position: relative;
        }
        .item-card.legendary { border-color: var(--legendary); }
        .item-card.epic { border-color: var(--epic); }
        .item-card.rare { border-color: var(--rare); }
        .item-card .name { font-size: 12px; font-weight: bold; display: block; margin-bottom: 5px; }
        .item-card .count { color: var(--accent); font-size: 14px; }
        .del-btn { position: absolute; top: 5px; right: 8px; color: var(--danger); cursor: pointer; font-weight: bold; }

        .chat-log { background: #0f0f1a; padding: 10px; border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto; }
        .tag { display: inline-block; background: #3d3d5c; padding: 4px 10px; border-radius: 20px; font-size: 11px; margin: 2px; }

        .footer { padding: 20px; background: #252545; display: flex; gap: 15px; justify-content: flex-end; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: var(--accent); color: white; }
        .btn-close { background: #444; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1>Chronos Master Control</h1>
    <table id="userTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>Level</th>
                <th>Coins</th>
                <th>Essence</th>
                <th>AI Name</th>
                <th>Warns</th>
            </tr>
        </thead>
        <tbody id="userList"></tbody>
    </table>
</div>

<div id="overlay" onclick="closeEdit()"></div>

<div id="editForm">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'main')">üìä –û–±—â–µ–µ</button>
        <button class="tab-btn" onclick="openTab(event, 'inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
        <button class="tab-btn" onclick="openTab(event, 'nova')">ü§ñ Nova AI</button>
        <button class="tab-btn" onclick="openTab(event, 'skills')">‚ö° –ù–∞–≤—ã–∫–∏</button>
    </div>

    <div class="content">
        <div id="main" class="tab-content active">
            <div class="grid">
                <div class="section">
                    <h4>–ë–∞–∑–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                    <input type="hidden" id="editId">
                    <label>–ù–∏–∫–Ω–µ–π–º</label><input type="text" id="inpUser">
                    <label>–£—Ä–æ–≤–µ–Ω—å / –°–æ–æ–±—â–µ–Ω–∏—è</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="inpLvl">
                        <input type="number" id="inpMsgs">
                    </div>
                    <label>–í–∞–ª—é—Ç–∞ (Coins / Essence)</label>
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="inpCoins">
                        <input type="number" id="inpEssence">
                    </div>
                </div>
                <div class="section">
                    <h4>–°–∫–ª–∞–¥ —Ä–µ—Å—É—Ä—Å–æ–≤</h4>
                    <div id="resGrid" style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
                        </div>
                </div>
                <div class="section">
                    <h4>–°–∏—Å—Ç–µ–º–Ω–æ–µ</h4>
                    <label>Clan ID</label><input type="text" id="inpClan">
                    <label>–í–∞—Ä–Ω—ã</label><input type="number" id="inpWarns">
                    <label>–ö–æ–º–∞–Ω–¥</label><input type="number" id="inpCmds">
                </div>
            </div>
            <h4>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h4>
            <div id="achievementsContainer"></div>
        </div>

        <div id="inventory" class="tab-content">
            <div class="section" style="background: #252545; border: 1px solid var(--accent);">
                <h4>üéÅ –í—ã–¥–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç</h4>
                <div style="display:flex; gap:10px;">
                    <select id="addItemSelect" style="flex:2;"></select>
                    <input type="number" id="addItemCount" value="1" style="flex:0.5;">
                    <button class="btn btn-save" onclick="addItemToUser()" style="padding:0 20px;">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
            <h4>üéí –ü—Ä–µ–¥–º–µ—Ç—ã –∏–≥—Ä–æ–∫–∞</h4>
            <div id="inventoryList" class="inv-grid"></div>
        </div>

        <div id="nova" class="tab-content">
            <div class="grid">
                <div class="section">
                    <h4>–ü—Ä–æ—Ñ–∏–ª—å –ù–æ–≤—ã</h4>
                    <label>–ò–º—è</label><input type="text" id="aiName">
                    <label>–í–æ–∑—Ä–∞—Å—Ç</label><input type="number" id="aiAge">
                    <label>–û—Ç–Ω–æ—à–µ–Ω–∏—è</label><input type="number" step="0.1" id="aiRel">
                    <label>–°—Ç–∏–ª—å —Ä–µ—á–∏</label><input type="text" id="aiStyle">
                </div>
                <div class="section" style="grid-column: span 2;">
                    <h4>–õ–æ–≥ –¥–∏–∞–ª–æ–≥–∞</h4>
                    <div id="aiChat" class="chat-log"></div>
                    <h4 style="margin-top:15px;">–¢–µ–∫—É—â–∏–π –∫–≤–µ—Å—Ç</h4>
                    <div id="aiQuest" class="section" style="background:#0f0f1a; margin-bottom:0;"></div>
                </div>
            </div>
        </div>

        <div id="skills" class="tab-content">
            <h4>–ü—Ä–æ–∫–∞—á–∫–∞ –Ω–∞–≤—ã–∫–æ–≤</h4>
            <div id="skillsGrid" class="grid"></div>
        </div>
    </div>

    <div class="footer">
        <button class="btn btn-close" onclick="closeEdit()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-save" onclick="saveData()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
    </div>
</div>

<script>
    // –ö–û–ù–°–¢–ê–ù–¢–´
    const AVAILABLE_RESOURCES = ["wood", "stone", "iron", "gold", "food", "magic_crystals", "ores", "fabric", "rare_artifacts"];
    const AVAILABLE_ITEMS = [
        {"name": "Talisman of Knowledge", "rarity": "common"}, {"name": "Coin Bank", "rarity": "common"},
        {"name": "Traveler‚Äôs Compass", "rarity": "common"}, {"name": "Wooden Ring", "rarity": "common"},
        {"name": "Lucky Charm", "rarity": "common"}, {"name": "Energy Drink", "rarity": "rare"},
        {"name": "Amulet of Wisdom", "rarity": "rare"}, {"name": "Silver Quill", "rarity": "rare"},
        {"name": "Ring of Focus", "rarity": "rare"}, {"name": "Scholar‚Äôs Book", "rarity": "rare"},
        {"name": "Golden Purse", "rarity": "epic"}, {"name": "Crystal of Luck", "rarity": "epic"},
        {"name": "Cloak of Insight", "rarity": "epic"}, {"name": "Orb of Fortune", "rarity": "epic"},
        {"name": "Crown of Clarity", "rarity": "epic"}, {"name": "Crown of Mastery", "rarity": "legendary"},
        {"name": "Philosopher's Stone", "rarity": "legendary"}, {"name": "Eternal Flame", "rarity": "legendary"},
        {"name": "Timekeeper‚Äôs Hourglass", "rarity": "legendary"}, {"name": "Book of Eternity", "rarity": "legendary"}
    ];

    let currentUser = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    const select = document.getElementById('addItemSelect');
    AVAILABLE_ITEMS.forEach(i => {
        let opt = document.createElement('option');
        opt.value = i.name;
        opt.innerText = `${i.name} (${i.rarity})`;
        select.appendChild(opt);
    });

    async function loadUsers() {
        try {
            const res = await fetch('/api/users');
            const users = await res.json();
            const list = document.getElementById('userList');
            list.innerHTML = users.map(u => `
                <tr onclick='openEdit(${JSON.stringify(u).replace(/'/g, "&apos;")})'>
                    <td><b>@${u.username}</b></td>
                    <td>Lvl ${u.level}</td>
                    <td>${u.coins.toLocaleString()}</td>
                    <td>${u.essence}</td>
                    <td>${u.ai_profile?.name || 'Nova'}</td>
                    <td>${u.warns}</td>
                </tr>
            `).join('');
        } catch(e) { console.error("Load error:", e); }
    }

    function openEdit(u) {
        currentUser = JSON.parse(JSON.stringify(u)); // –ì–ª—É–±–æ–∫–∞—è –∫–æ–ø–∏—è
        document.getElementById('editId').value = u._id;
        document.getElementById('inpUser').value = u.username;
        document.getElementById('inpLvl').value = u.level;
        document.getElementById('inpMsgs').value = u.messages || 0;
        document.getElementById('inpCoins').value = u.coins;
        document.getElementById('inpEssence').value = u.essence;
        document.getElementById('inpClan').value = u.clan_id || '';
        document.getElementById('inpCmds').value = u.commands_count || 0;
        document.getElementById('inpWarns').value = u.warns || 0;

        // –†–µ—Å—É—Ä—Å—ã
        const resGrid = document.getElementById('resGrid');
        resGrid.innerHTML = AVAILABLE_RESOURCES.map(r => `
            <div>
                <label>${r.replace('_',' ')}</label>
                <input type="number" id="res_${r}" value="${u.resources?.[r] || 0}" data-res-key="${r}">
            </div>
        `).join('');

        renderInventory();

        // AI
        const ai = u.ai_profile || {};
        document.getElementById('aiName').value = ai.name || '';
        document.getElementById('aiAge').value = ai.age || '';
        document.getElementById('aiRel').value = ai.relationship_level || 0;
        document.getElementById('aiStyle').value = ai.speech_style || '';
        document.getElementById('aiChat').innerHTML = u.ai_history?.map(m => `
            <div class="msg"><b>${m.role}:</b> ${m.content}</div>
        `).join('') || '–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞';
        document.getElementById('aiQuest').innerText = ai.quest?.meta?.text || '–ù–µ—Ç –∫–≤–µ—Å—Ç–∞';

        // –ù–∞–≤—ã–∫–∏
        const skGrid = document.getElementById('skillsGrid');
        skGrid.innerHTML = Object.entries(u.skills || {}).map(([s, v]) => `
            <div><label>${s}</label><input type="number" value="${v}" data-skill="${s}"></div>
        `).join('');

        // –ê—á–∏–≤–∫–∏
        document.getElementById('achievementsContainer').innerHTML = (u.achievements || []).map(a => `<span class="tag">${a}</span>`).join('');

        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editForm').style.display = 'flex';
    }

    function renderInventory() {
        const invList = document.getElementById('inventoryList');
        invList.innerHTML = '';
        for (const [name, data] of Object.entries(currentUser.inventory || {})) {
            if (typeof data === 'object') {
                invList.innerHTML += `
                    <div class="item-card ${data.rarity}">
                        <span class="del-btn" onclick="removeItem('${name}')">√ó</span>
                        <span class="name">${name}</span>
                        <span class="count">x${data.amount}</span>
                    </div>`;
            }
        }
    }

    function addItemToUser() {
        const name = document.getElementById('addItemSelect').value;
        const count = parseInt(document.getElementById('addItemCount').value);
        const info = AVAILABLE_ITEMS.find(i => i.name === name);

        if (!currentUser.inventory) currentUser.inventory = {};
        if (currentUser.inventory[name]) {
            currentUser.inventory[name].amount += count;
        } else {
            currentUser.inventory[name] = { amount: count, rarity: info.rarity };
        }
        renderInventory();
    }

    function removeItem(name) {
        delete currentUser.inventory[name];
        renderInventory();
    }

    async function saveData() {
        const updateData = {
            "username": document.getElementById('inpUser').value,
            "level": Number(document.getElementById('inpLvl').value),
            "coins": Number(document.getElementById('inpCoins').value),
            "essence": Number(document.getElementById('inpEssence').value),
            "warns": Number(document.getElementById('inpWarns').value),
            "clan_id": document.getElementById('inpClan').value,
            "inventory": currentUser.inventory,
            "ai_profile.name": document.getElementById('aiName').value,
            "ai_profile.relationship_level": Number(document.getElementById('aiRel').value),
            "ai_profile.speech_style": document.getElementById('aiStyle').value,
            "ai_profile.age": Number(document.getElementById('aiAge').value)
        };

        // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ—Å—É—Ä—Å—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
        document.querySelectorAll('[data-res-key]').forEach(input => {
            updateData[`resources.${input.dataset.resKey}`] = Number(input.value);
        });

        // –°–æ–±–∏—Ä–∞–µ–º –Ω–∞–≤—ã–∫–∏
        document.querySelectorAll('[data-skill]').forEach(input => {
            updateData[`skills.${input.dataset.skill}`] = Number(input.value);
        });

        const res = await fetch('/api/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: currentUser._id, updateData })
        });

        if (res.ok) {
            closeEdit();
            loadUsers();
        } else { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏!"); }
    }

    function openTab(evt, tabName) {
        const contents = document.getElementsByClassName("tab-content");
        for (let i = 0; i < contents.length; i++) contents[i].classList.remove("active");
        const btns = document.getElementsByClassName("tab-btn");
        for (let i = 0; i < btns.length; i++) btns[i].classList.remove("active");
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    function closeEdit() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editForm').style.display = 'none';
    }

    loadUsers();
</script>

</body>
</html>
