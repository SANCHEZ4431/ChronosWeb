<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos Master Control v3.2 Premium</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #05050a; 
            --surface: #0f0f1e; 
            --surface-light: #1a1a2e;
            --accent: #00e5ff; 
            --accent-glow: rgba(0, 229, 255, 0.3);
            --text: #f0f0f0;
            --text-dim: #94a3b8;
            --legendary: #ffaa00; 
            --epic: #d000ff; 
            --rare: #0077ff; 
            --common: #ffffff;
            --danger: #ff3366;
            --success: #00ffa3;
            --vip: #fcd34d;
            --admin: #ef4444;
        }

        /* --- Global Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: var(--surface-light); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
            line-height: 1.5;
        }

        .container { 
            max-width: 1500px; 
            margin: 0 auto; 
            padding: 40px 25px; 
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            background: linear-gradient(90deg, var(--surface) 0%, transparent 100%);
            padding: 20px;
            border-radius: 16px;
            border-left: 4px solid var(--accent);
        }

        .logo h1 {
            margin: 0;
            font-weight: 800;
            letter-spacing: -1px;
            font-size: 28px;
            background: linear-gradient(135deg, #fff 30%, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-overview {
            display: flex;
            gap: 20px;
        }

        .stat-pill {
            background: var(--surface-light);
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .stat-pill span { color: var(--accent); font-weight: 800; }

        .table-card {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.08);
            overflow: hidden;
        }

        table { width: 100%; border-collapse: collapse; }
        th { 
            background: rgba(255,255,255,0.02); 
            color: var(--text-dim); 
            font-size: 11px; 
            text-transform: uppercase; 
            padding: 20px;
            text-align: left;
            letter-spacing: 1.5px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        td { 
            padding: 18px 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.03); 
            font-size: 14px;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(0, 229, 255, 0.03); cursor: pointer; }
        
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .avatar-stub {
            width: 35px; height: 35px;
            background: var(--surface-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: var(--accent);
            border: 1px solid var(--accent);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
        }
        .badge-vip { background: var(--vip); color: #000; box-shadow: 0 0 15px rgba(241, 196, 15, 0.3); }
        .badge-admin { background: var(--admin); color: #fff; box-shadow: 0 0 15px rgba(255, 51, 102, 0.3); }

        #overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            backdrop-filter: blur(10px);
            z-index: 1000; 
        }

        #editForm {
            display: none; 
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            background: var(--surface); 
            width: 1250px; 
            height: 90vh;
            border-radius: 24px;
            z-index: 1001; 
            overflow: hidden; 
            flex-direction: column; 
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 120px rgba(0,0,0,1);
        }

        .tabs-header { 
            display: flex; 
            background: var(--surface-light); 
            padding: 10px 30px 0; 
            gap: 5px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .tab-btn { 
            padding: 16px 24px; 
            border: none; 
            background: transparent; 
            color: var(--text-dim); 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 13px;
            border-radius: 12px 12px 0 0; 
            transition: 0.3s;
        }
        .tab-btn.active { 
            background: var(--surface); 
            color: var(--accent); 
            box-shadow: 0 -5px 15px rgba(0,0,0,0.3);
        }

        .modal-scrollbox { padding: 40px; overflow-y: auto; flex-grow: 1; }
        .tab-content { display: none; animation: slideUp 0.4s ease forwards; }
        .tab-content.active { display: block; }

        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .editor-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; }
        .card-box { 
            background: rgba(255,255,255,0.02); 
            padding: 25px; 
            border-radius: 20px; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .card-box h3 { 
            margin: 0 0 20px 0; 
            color: var(--accent); 
            font-size: 13px; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label { display: block; font-size: 11px; color: var(--text-dim); margin: 15px 0 6px; text-transform: uppercase; font-weight: 700; }
        input, select, textarea { 
            width: 100%; 
            padding: 12px 16px; 
            background: var(--bg); 
            border: 1px solid rgba(255,255,255,0.1); 
            color: #fff; 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-family: 'Inter', sans-serif;
            transition: 0.3s;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .inv-wrapper { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .item-tile { 
            background: var(--bg); 
            padding: 20px; 
            border-radius: 15px; 
            border-left: 5px solid #444; 
            position: relative;
        }
        .item-tile.legendary { border-left-color: var(--legendary); }
        .item-tile.epic { border-left-color: var(--epic); }
        .item-tile.rare { border-left-color: var(--rare); }
        .item-tile .name { display: block; font-weight: 800; margin-bottom: 5px; font-size: 13px; }
        .item-tile .val { font-family: 'Fira Code'; color: var(--accent); font-size: 16px; }

        .modal-footer { padding: 25px 40px; background: var(--surface-light); display: flex; justify-content: flex-end; gap: 20px; }
        .btn { 
            padding: 14px 30px; 
            border-radius: 12px; 
            border: none; 
            cursor: pointer; 
            font-weight: 800; 
            font-size: 14px;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-save { background: var(--accent); color: #000; }
        .btn-save:hover { transform: translateY(-3px); box-shadow: 0 10px 20px var(--accent-glow); }
        .btn-close { background: rgba(255,255,255,0.05); color: #fff; }
        
        #toast {
            position: fixed; bottom: 40px; right: 40px; background: var(--surface-light);
            padding: 20px 35px; border-radius: 15px; border-left: 5px solid var(--accent);
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); z-index: 9999;
            transform: translateX(200%); transition: 0.6s cubic-bezier(0.23, 1, 0.32, 1);
        }
        #toast.visible { transform: translateX(0); }

        /* ================= MOBILE ADAPTATION ================= */
        @media (max-width: 900px) {
        
            .container {
                padding: 15px 10px;
            }
        
            header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        
            .stats-overview {
                flex-wrap: wrap;
                gap: 10px;
            }
        
            .search-bar {
                flex-direction: column !important;
            }
        
            .search-bar input {
                height: 45px !important;
                font-size: 14px;
            }
        
            /* ==== TABLE -> CARDS ==== */
            table, thead, tbody, th, tr {
                display: block;
                width: 100%;
            }
        
            thead {
                display: none;
            }
        
            tr {
                background: var(--surface);
                border-radius: 16px;
                margin-bottom: 15px;
                padding: 10px;
                border: 1px solid rgba(255,255,255,0.05);
            }
        
            td {
                display: flex;
                justify-content: space-between;
                padding: 8px 10px;
                font-size: 13px;
                border-bottom: 1px solid rgba(255,255,255,0.05);
            }
        
            td:last-child {
                border-bottom: none;
            }
        
            td::before {
                content: attr(data-label);
                color: var(--text-dim);
                font-size: 11px;
                text-transform: uppercase;
            }
        
            /* ==== MODAL ==== */
            #editForm {
                width: 100%;
                height: 100vh;
                border-radius: 0;
                top: 0;
                left: 0;
                transform: none;
            }
        
            .tabs-header {
                overflow-x: auto;
                padding: 5px;
            }
        
            .tab-btn {
                padding: 12px 14px;
                font-size: 11px;
                white-space: nowrap;
            }
        
            .modal-scrollbox {
                padding: 15px;
            }
        
            .editor-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        
            #dynamic-res-grid,
            #dynamic-skills-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 10px !important;
            }
        
            .inv-wrapper {
                grid-template-columns: repeat(2, 1fr);
            }
        
            .modal-footer {
                padding: 15px;
                flex-direction: column;
            }
        
            .btn {
                width: 100%;
            }
        
            #toast {
                right: 10px;
                left: 10px;
                bottom: 15px;
                text-align: center;
            }
        }

    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">
            <h1>Chronos Master Control</h1>
        </div>
        <div class="stats-overview">
            <div class="stat-pill">Users: <span id="count-users">0</span></div>
            <div class="stat-pill">VIP: <span id="count-vips">0</span></div>
            <button class="btn btn-save" style="padding: 8px 15px; font-size: 12px;" onclick="loadUsers()">üîÑ Reload</button>
            <button class="btn btn-close" style="padding: 8px 15px; font-size: 12px; background: rgba(255,51,102,0.1); border: 1px solid var(--danger); color: var(--danger);" onclick="logout()">üö™ Logout</button>
        </div>
    </header>

    <div class="search-bar" style="margin-bottom: 20px; display: flex; gap: 15px;">
        <div style="position: relative; flex: 1;">
            <input type="text" id="userSearch" placeholder="Search by ID or Username (e.g. @sanchez or 505952...)" 
                   style="padding-left: 45px; height: 50px; background: var(--surface); border: 1px solid rgba(255,255,255,0.1);"
                   oninput="filterUsers()">
            <span style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-dim); font-size: 18px;">üîç</span>
        </div>
        <div class="stat-pill" style="display: flex; align-items: center; justify-content: center; min-width: 150px;">
            Found: <span id="count-found" style="margin-left: 8px;">0</span>
        </div>
    </div>

    <div class="table-card">
        <table id="userTable">
            <thead>
                <tr>
                    <th>Identifier</th>
                    <th>User Profile</th>
                    <th>Level / XP</th>
                    <th>Finances</th>
                    <th>Resources</th>
                    <th>Nova AI</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="userList">
                <tr><td colspan="7" style="text-align:center; padding: 60px; color: var(--text-dim);">Connecting to Database Nexus...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="overlay" onclick="closeEdit()"></div>

<div id="editForm">
    <div class="tabs-header">
        <button class="tab-btn active" onclick="openTab(event, 'p-main')">üìä Profile</button>
        <button class="tab-btn" onclick="openTab(event, 'p-res')">üì¶ Resources</button>
        <button class="tab-btn" onclick="openTab(event, 'p-skills')">‚ö° Skills</button>
        <button class="tab-btn" onclick="openTab(event, 'p-inv')">üéí Inventory</button>
        <button class="tab-btn" onclick="openTab(event, 'p-nova')">ü§ñ Nova AI</button>
        <button class="tab-btn" onclick="openTab(event, 'p-system')">‚öôÔ∏è System</button>
    </div>

    <div class="modal-scrollbox">
        <div id="p-main" class="tab-content active">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üë§ Identity</h3>
                    <label>Internal ID</label><input type="text" id="v-id" disabled>
                    <label>Alias / Username</label><input type="text" id="v-user">
                    <label>Current Level</label><input type="number" id="v-lvl">
                    <label>Experience Points</label><input type="number" id="v-xp">
                </div>
                <div class="card-box">
                    <h3>üíé Economics</h3>
                    <label>Gold Coins</label><input type="number" id="v-coins">
                    <label>Void Essence</label><input type="number" id="v-essence">
                    <label>Clan Association</label><input type="text" id="v-clan">
                </div>
                <div class="card-box">
                    <h3>üõ°Ô∏è Privileges</h3>
                    <label>Admin Rights</label>
                    <select id="v-is-admin" onchange="toggleAdmin(this.value)">
                        <option value="false">Standard User</option>
                        <option value="true">System Administrator</option>
                    </select>
                
                    <label>VIP Subscription Control</label>
                    <div id="vip-info" style="font-size: 11px; margin-bottom: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;"></div>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="number" id="vip-days-input" value="30" style="flex: 1;" placeholder="Days">
                        <button class="btn btn-save" style="flex: 2; padding: 10px;" onclick="grantVipCustom()">Grant VIP</button>
                    </div>
                    
                    <button class="btn btn-close" style="width:100%; color: var(--danger); border: 1px solid rgba(255,51,102,0.3);" onclick="revokeVip()">Revoke VIP Status</button>
                </div>
            </div>
        </div>

        <div id="p-res" class="tab-content">
            <div class="card-box">
                <h3>üì¶ Raw Materials</h3>
                <div id="dynamic-res-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 20px;"></div>
            </div>
        </div>

        <div id="p-skills" class="tab-content">
            <div class="card-box">
                <h3>‚ö° Active Skill Levels</h3>
                <div id="dynamic-skills-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap: 20px;"></div>
            </div>
        </div>

        <div id="p-inv" class="tab-content">
            <div class="card-box" style="margin-bottom:20px; background: rgba(0, 229, 255, 0.05);">
                <h3>‚ú® Item Injection</h3>
                <div style="display:flex; gap:15px;">
                    <select id="add-item-sel" style="flex:2;">
                        </select>
                    <input type="number" id="add-item-qty" value="1" style="flex:0.5;">
                    <button class="btn btn-save" onclick="addItemToInv()">Inject</button>
                </div>
            </div>
            <div id="inv-list" class="inv-wrapper"></div>
        </div>

        <div id="p-nova" class="tab-content">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üß† Personality</h3>
                    <label>Nova Name</label><input type="text" id="ai-name">
                    <label>Relationship Level</label><input type="number" id="ai-rel">
                    <label>Gender/Type</label><input type="text" id="ai-gender">
                    <label>Speech Style</label><textarea id="ai-style" rows="3"></textarea>
                </div>
                <div class="card-box" style="grid-column: span 2;">
                    <h3>üéûÔ∏è Recent Memory</h3>
                    <div id="ai-logs" style="height:350px; background:#000; border-radius:10px; padding:15px; overflow-y:auto; font-family:'Fira Code'; font-size:12px;"></div>
                </div>
            </div>
        </div>

        <div id="p-system" class="tab-content">
            <div class="editor-grid">
                <div class="card-box">
                    <h3>üö´ Access Control</h3>
                    <label>Ban Status</label>
                    <select id="v-banned">
                        <option value="false">No Restriction</option>
                        <option value="true">BANNED</option>
                    </select>
                    <label>Warn Count</label><input type="number" id="v-warns">
                </div>
                <div class="card-box">
                    <h3>üïí Cooldowns</h3>
                    <div id="cd-list" style="font-size:12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button class="btn btn-close" onclick="closeEdit()">Discard</button>
        <button class="btn btn-save" onclick="processSave()">üíæ Commit Changes</button>
    </div>
</div>

<div id="toast">Operation Successful</div>

<script>
    const RES_TYPES = ["gold", "wood", "stone", "iron", "magic_crystals", "ores", "fabric", "food", "rare_artifacts"];
    const SKILL_TYPES = ["exp_boost", "resource_gain", "luck", "gold_gain", "wisdom", "cooldown_reduction", "pet_bonus"];

    let allUsers = [];
    let activeUser = null;

    async function loadUsers() {
        try {
            const r = await fetch('/api/users');
            allUsers = await r.json();
            document.getElementById('userSearch').value = ''; // –°–±—Ä–æ—Å –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
            renderTable();
            updateStats();
            console.log("Data refreshed from DB");
        } catch(e) { 
            console.error("API Error", e); 
        }
    }

    function filterUsers() {
        const query = document.getElementById('userSearch').value.toLowerCase().trim();
        
        // –ï—Å–ª–∏ –ø–æ–∏—Å–∫ –ø—É—Å—Ç–æ–π, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ—Ö
        if (!query) {
            renderTable(allUsers);
            return;
        }
    
        const filtered = allUsers.filter(u => {
            const idMatch = String(u._id).includes(query);
            const nameMatch = (u.username || "").toLowerCase().includes(query.replace('@', ''));
            return idMatch || nameMatch;
        });
    
        renderTable(filtered);
        document.getElementById('count-found').innerText = filtered.length;
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ (–∑–∞–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ä—É—é)
    // –¢–µ–ø–µ—Ä—å –æ–Ω–∞ –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –º–∞—Å—Å–∏–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–ª—è –ø–æ–∏—Å–∫–∞)
    function renderTable(dataToRender = allUsers) {
        const body = document.getElementById('userList');
        
        if (dataToRender.length === 0) {
            body.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 60px; color: var(--text-dim);">No users found matching your request.</td></tr>`;
            return;
        }
    
        body.innerHTML = dataToRender.map((u) => {
            // –ù–∞—Ö–æ–¥–∏–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ allUsers –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ editUser
            const originalIndex = allUsers.findIndex(original => original._id === u._id);
            
            const isAdmin = u.is_admin === true;
            const isVip = u.is_vip === true; 
            const isBanned = u.banned === true;
            
            return `
            <tr onclick="editUser(${originalIndex})">
                <td data-label="ID" class="user-id">#${u._id}</td>
                <td data-label="User">
                    <div class="user-cell">
                        <div class="avatar-stub">${(u.username || 'U').charAt(0).toUpperCase()}</div>
                        <b>@${u.username || 'NoName'}</b>
                    </div>
                </td>
                <td data-label="Level">Lvl ${u.level || 1} <br><small>XP: ${u.exp || u.xp || 0}</small></td>
                <td data-label="Money">üí∞ ${u.coins?.toLocaleString() || 0}</td>
                <td data-label="Resources">üì¶ ${Object.values(u.resources || {}).reduce((a,b)=>a+b, 0)}</td>
                <td data-label="AI">${u.ai_profile?.name || 'Nova'}</td>
                <td data-label="Status">
                    ${isBanned ? '<span class="badge" style="background:var(--danger)">Banned</span>' : ''}
                    ${isAdmin ? '<span class="badge badge-admin">Developer</span>' : ''}
                    ${isVip ? '<span class="badge badge-vip">VIP</span>' : ''}
                    ${!isAdmin && !isVip && !isBanned ? '<span class="badge" style="background:rgba(255,255,255,0.05)">User</span>' : ''}
                </td>
            </tr>`;
        }).join('');
    
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö
        document.getElementById('count-found').innerText = dataToRender.length;
    }

    function editUser(index) {
        activeUser = JSON.parse(JSON.stringify(allUsers[index]));
        
        document.getElementById('v-id').value = activeUser._id;
        document.getElementById('v-user').value = activeUser.username || '';
        document.getElementById('v-lvl').value = activeUser.level || 1;
        document.getElementById('v-xp').value = activeUser.exp || activeUser.xp || 0;
        document.getElementById('v-coins').value = activeUser.coins || 0;
        document.getElementById('v-essence').value = activeUser.essence || 0;
        document.getElementById('v-is-admin').value = String(activeUser.is_admin || false);
        document.getElementById('v-clan').value = activeUser.clan_id || '';
        document.getElementById('v-banned').value = String(activeUser.banned || false);
        document.getElementById('v-warns').value = activeUser.warns || 0;

        updateVipUI();

        // Resources Tab
        const resGrid = document.getElementById('dynamic-res-grid');
        resGrid.innerHTML = RES_TYPES.map(rt => `
            <div>
                <label>${rt.replace(/_/g,' ')}</label>
                <input type="number" value="${activeUser.resources?.[rt] || 0}" data-res-key="${rt}">
            </div>
        `).join('');

        // Skills Tab
        const skillGrid = document.getElementById('dynamic-skills-grid');
        skillGrid.innerHTML = SKILL_TYPES.map(st => `
            <div>
                <label>${st.replace(/_/g,' ')}</label>
                <input type="number" value="${activeUser.skills?.[st] || 0}" data-skill-key="${st}">
            </div>
        `).join('');

        // AI 
        const ai = activeUser.ai_profile || {};
        document.getElementById('ai-name').value = ai.name || 'Nova';
        document.getElementById('ai-rel').value = ai.relationship_level || 0;
        document.getElementById('ai-gender').value = ai.gender || '';
        document.getElementById('ai-style').value = ai.speech_style || '';

        // AI History
        const aiLogs = document.getElementById('ai-logs');
        if (activeUser.ai_history && activeUser.ai_history.length > 0) {
            aiLogs.innerHTML = activeUser.ai_history.map(msg => `
                <div style="margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px;">
                    <span style="color: var(--accent)">[${msg.role?.toUpperCase()}]:</span> 
                    <span style="color: #ccc">${msg.content}</span>
                </div>
            `).join('');
        } else { aiLogs.innerHTML = 'Memory Empty'; }

        // Cooldowns
        const cdList = document.getElementById('cd-list');
        const cds = activeUser.cooldowns || {};
        cdList.innerHTML = Object.keys(cds).length ? Object.entries(cds).map(([k, v]) => {
            const date = new Date(v);
            const expired = date < new Date();
            return `<div style="color:${expired ? 'var(--success)' : 'var(--danger)'}"><b>${k}:</b> ${expired ? 'Ready' : date.toLocaleString()}</div>`;
        }).join('') : 'No active cooldowns';

        renderInv();
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editForm').style.display = 'flex';
    }

    function updateVipUI() {
        const vipInfo = document.getElementById('vip-info');
        // –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª —Å–µ—Ä–≤–µ—Ä –ø–æ—Å–ª–µ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
        if (activeUser.is_vip) {
            const expiryDate = activeUser.vip_until ? new Date(activeUser.vip_until).toLocaleDateString() : "Lifetime";
            vipInfo.innerHTML = `<b style="color:var(--vip)">‚úÖ VIP ACTIVE</b><br>Expires: ${expiryDate}`;
        } else {
            vipInfo.innerHTML = `<b style="color:var(--text-dim)">‚ùå VIP INACTIVE</b>`;
        }
    }

    async function grantVipCustom() {
        const days = document.getElementById('vip-days-input').value;
        if (!days || days <= 0) return alert("Please enter valid number of days");
    
        try {
            const res = await fetch('/api/set-vip', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    user_id: activeUser._id, 
                    days: parseInt(days) 
                })
            });
    
            if(res.ok) {
                showToast(`VIP granted for ${days} days`);
                // –õ–æ–∫–∞–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –¥–ª—è UI, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                const newDate = new Date();
                newDate.setDate(newDate.getDate() + parseInt(days));
                activeUser.is_vip = true;
                activeUser.vip_until = newDate;
                updateVipUI();
            }
        } catch(e) {
            alert("Error updating VIP status");
        }
    }
    async function revokeVip() {
        if(!confirm("Are you sure you want to revoke VIP status?")) return;
        activeUser.is_vip = false;
        activeUser.vip_until = null;
        // –ü—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ –æ—Å–Ω–æ–≤–Ω–æ–π API
        processSave();
    }

    async function toggleAdmin(val) {
        const action = val === 'true' ? 'add' : 'remove';
        try {
            const res = await fetch('/api/set-admin', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ user_id: activeUser._id, action: action })
            });
            if(res.ok) showToast(`Admin status: ${val}`);
        } catch(e) { console.error(e); }
    }

    async function logout() {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏?")) return;
    
        try {
            const res = await fetch('/api/logout', { method: 'POST' });
            if (res.ok) {
                // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
                window.location.href = '/login.html'; // –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –≤–∞—à–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ª–æ–≥–∏–Ω–∞
            }
        } catch (e) {
            console.error("Logout error:", e);
            // –ï—Å–ª–∏ API –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª–æ, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É (—Å–µ—Ä–≤–µ—Ä —Å–∞–º –≤—ã–∫–∏–Ω–µ—Ç –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è —Å–µ—Å—Å–∏–∏)
            window.location.reload();
        }
    }

    function renderInv() {
        const box = document.getElementById('inv-list');
        box.innerHTML = '';
        const items = activeUser.inventory || {};
        
        for (let key in items) {
            let amount, rarity;
    
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–º (–∫–∞–∫ Crown of Mastery) –∏–ª–∏ —á–∏—Å–ª–æ–º (–∫–∞–∫ shadow_note)
            if (typeof items[key] === 'object' && items[key] !== null) {
                amount = items[key].amount || 0;
                rarity = items[key].rarity || 'common';
            } else {
                // –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ (—Å–ª—É—á–∞–π shadow_note: 5)
                amount = items[key];
                rarity = 'common'; 
            }
    
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–æ–ª—è, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ inventory
            if (['exp', 'coins', 'resources'].includes(key)) continue;
    
            box.innerHTML += `
                <div class="item-tile ${rarity}">
                    <span class="name">${key}</span>
                    <span class="val">x${amount}</span>
                    <button onclick="remItem('${key}')" style="position:absolute; top:5px; right:5px; background:none; border:none; color:red; cursor:pointer; font-size: 18px;">√ó</button>
                </div>
            `;
        }
    }

    // 1. –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –≤—Å–µ—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
    const AVAILABLE_ITEMS = [
        {"name": "Talisman of Knowledge", "rarity": "common"},
        {"name": "Coin Bank", "rarity": "common"},
        {"name": "Traveler‚Äôs Compass", "rarity": "common"},
        {"name": "Wooden Ring", "rarity": "common"},
        {"name": "Lucky Charm", "rarity": "common"},
        {"name": "Energy Drink", "rarity": "rare"},
        {"name": "Amulet of Wisdom", "rarity": "rare"},
        {"name": "Silver Quill", "rarity": "rare"},
        {"name": "Ring of Focus", "rarity": "rare"},
        {"name": "Scholar‚Äôs Book", "rarity": "rare"},
        {"name": "Golden Purse", "rarity": "epic"},
        {"name": "Crystal of Luck", "rarity": "epic"},
        {"name": "Cloak of Insight", "rarity": "epic"},
        {"name": "Orb of Fortune", "rarity": "epic"},
        {"name": "Crown of Clarity", "rarity": "epic"},
        {"name": "Crown of Mastery", "rarity": "legendary"},
        {"name": "Philosopher's Stone", "rarity": "legendary"},
        {"name": "Eternal Flame", "rarity": "legendary"},
        {"name": "Timekeeper‚Äôs Hourglass", "rarity": "legendary"},
        {"name": "Book of Eternity", "rarity": "legendary"},
        {"name": "shadow_note"}
    ];
    
    // 2. –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ (–≤—ã–∑–æ–≤–∏—Ç–µ –µ—ë –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
    function initItemSelector() {
        const sel = document.getElementById('add-item-sel');
        sel.innerHTML = AVAILABLE_ITEMS.map(item => {
            // –ï—Å–ª–∏ rarity –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º 'common' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            const rarityText = (item.rarity || 'common').toUpperCase(); 
            return `<option value="${item.name}">${item.name} (${rarityText})</option>`;
        }).join('');
    }
    
    // 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function addItemToInv() {
        const name = document.getElementById('add-item-sel').value;
        const qty = parseInt(document.getElementById('add-item-qty').value);
        
        // –ù–∞—Ö–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–µ–¥–º–µ—Ç–µ, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å –µ–≥–æ —Ä–µ–¥–∫–æ—Å—Ç—å
        const itemData = AVAILABLE_ITEMS.find(i => i.name === name);
        
        if(!activeUser.inventory) activeUser.inventory = {};
        
        if(activeUser.inventory[name]) {
            activeUser.inventory[name].amount += qty;
        } else {
            activeUser.inventory[name] = { 
                amount: qty, 
                rarity: itemData ? itemData.rarity : 'common' 
            };
        }
        renderInv();
        showToast(`Injected: ${name} x${qty}`);
    }
    
    // –ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤—ã–∑–≤–∞—Ç—å initItemSelector() –≤ window.onload –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ —Å–∫—Ä–∏–ø—Ç–∞
    window.addEventListener('load', () => {
        initItemSelector();
        loadUsers();
    });

    function remItem(key) {
        delete activeUser.inventory[key];
        renderInv();
    }

    async function processSave() {
        const update = {
            username: document.getElementById('v-user').value,
            level: Number(document.getElementById('v-lvl').value),
            exp: Number(document.getElementById('v-xp').value),
            coins: Number(document.getElementById('v-coins').value),
            essence: Number(document.getElementById('v-essence').value),
            clan_id: document.getElementById('v-clan').value,
            is_admin: document.getElementById('v-is-admin').value === 'true',
            banned: document.getElementById('v-banned').value === 'true',
            warns: Number(document.getElementById('v-warns').value),
            is_vip: activeUser.is_vip,
            vip_until: activeUser.vip_until,
            inventory: activeUser.inventory,
            "ai_profile.name": document.getElementById('ai-name').value,
            "ai_profile.relationship_level": Number(document.getElementById('ai-rel').value),
            "ai_profile.gender": document.getElementById('ai-gender').value,
            "ai_profile.speech_style": document.getElementById('ai-style').value
        };

        document.querySelectorAll('[data-res-key]').forEach(el => {
            update[`resources.${el.dataset.resKey}`] = Number(el.value);
        });
        document.querySelectorAll('[data-skill-key]').forEach(el => {
            update[`skills.${el.dataset.skillKey}`] = Number(el.value);
        });

        const res = await fetch('/api/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ user_id: activeUser._id, updateData: update })
        });

        if(res.ok) {
            showToast("Sync Complete");
            closeEdit();
            loadUsers();
        }
    }

    function openTab(e, id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        e.currentTarget.classList.add('active');
    }

    function closeEdit() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editForm').style.display = 'none';
    }

    function showToast(m) {
        const t = document.getElementById('toast');
        t.innerText = m;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 3000);
    }

    function updateStats() {
        document.getElementById('count-users').innerText = allUsers.length;
        document.getElementById('count-vips').innerText = allUsers.filter(u => u.is_vip || (u.vip_until && new Date(u.vip_until) > new Date())).length;
    }

    loadUsers();
</script>
</body>
</html>
